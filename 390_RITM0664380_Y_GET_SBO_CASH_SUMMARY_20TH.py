#390 RITM0664380
import cx_Oracle
import pandas as pd
import xlwt
import datetime
import dateutil
import os
import win32com.client
from win32com.client import Dispatch, constants
from environment_settings import environment_ini
from environment_settings import email_ini
from environment_settings import pass_inifrom log import logopenfrom log import logmessage




adhocmonthsback = '0'

reportnum = '390'
snowticket = 'RITM0664380'


#write to log filelogopen(environment,reportnum)#To run ADHOC, change todayDate to month+1 for report (ex: 5/12/2021 will output for 4/1/2021, 4/30/2021 and 02/01/2021 variables (begdate,enddate,twomosprior))
todayDate = datetime.date.today()+dateutil.relativedelta.relativedelta(months=int(adhocmonthsback))
firstofmonth = todayDate.replace(day=1)
begdate = firstofmonth
enddate = begdate+dateutil.relativedelta.relativedelta(months=1)-dateutil.relativedelta.relativedelta(days=1)
twomosprior = begdate-dateutil.relativedelta.relativedelta(months=2)

print('Report for period starting: ' + str(begdate))
print('Report for period ending: ' + str(enddate))

begdate=begdate.strftime('%m/%d/%Y')
enddate=enddate.strftime('%m/%d/%Y')
twomosprior=twomosprior.strftime('%m/%d/%Y')

date = todayDate
year = str(date.year)
month = str(date.month)
day = str(date.day)

while len(month) < 2:
    month = '0' + month
while len(day) < 2:
    day = '0' + day
    

try:
    result = environment_ini(environment,reportnum,snowticket)
    reportname = result[0]
    filelocation = result[1] + '\\' +str(year) +str(month)+ '\\'
    database = result[2]
    hostname = result[3]
    port = result[4]
    oprodbridge = result[5]
    opdwdbbridge = result[6]
except Exception as e:
    logmessage(environment,'\n  Exception: ' + str(e))
    print('Exception: ' + str(e))
    quit()

try:
    result = pass_ini(environment)
    user = result
    password = result
except Exception as e:
    logmessage(environment,'\n  Exception: ' + str(e))
    print('Exception: ' + str(e))
    quit()

#pull business user details: user name, email, cc emails
try:
    result = email_ini(environment,reportnum)
    boname = result[0]
    businessowner = result[1]
    ccrecipients = result[2]
except Exception as e:
    logmessage(environment,'\n  Exception: ' + str(e))
    print('Exception: ' + str(e))
    quit()

#========================================================================================================================
#ETL:
#========================================================================================================================

etldata = pd.read_excel(r'\\corp.ocwen.com\data\laxa\Prod\Common\BondAdmn\Wells Fargo\SBO_Wells_Interest_Adjustments.xls', sheet_name = 0)

etlscript = 'SELECT 0,0,NULL FROM DUAL'

i = 0
x = len(etldata.index)-1

while i <= x:
    etlscript = etlscript+' \r\nUNION SELECT '+str(etldata.at[i,'LoanNumber'])+','+str(etldata.at[i,'Int_Adj_Amt'])+','+chr(39)+str(etldata.at[i,'Reason_Description'])+chr(39)+' FROM DUAL'
    i+=1

#========================================================================================================================
#SET VARIABLES FOR REPORT:
#========================================================================================================================

reportname = reportname + str('Y_GET_SBO_CASH_SUMMARY_20TH'+'_' + year + month + day)

tab1= 'SBO_CASH_SUMMARY_20TH'
tab2= 'VARIABLES'
tab3= 'Sheet3'


filename = str(reportname + '.xlsx')

if not os.path.exists(filelocation):
    os.makedirs(filelocation)

file = filelocation + filename

subject = reportname

writer = pd.ExcelWriter(file,engine='xlsxwriter',options={'strings_to_numbers': True})


try:
    try:
        cx_Oracle.init_oracle_client(lib_dir=r"C:\Users\balsambr\Downloads\SQL_IC\instantclient_19_10")
    except Exception as e:
        print('Oracle already initialized')
    dsn_tns = cx_Oracle.makedsn(hostname, port, service_name=database)
    cnxn = cx_Oracle.connect(user,password,dsn=dsn_tns)
    cursor = cnxn.cursor()

    script = """alter session set nls_date_format = 'mm/dd/yyyy'"""
    cursor.execute(script)
    
    masterscript = """
WITH VARIABLES AS
(
SELECT
(SELECT
    DT
FROM
    (
    SELECT
        DT,
        ROW_NUMBER() OVER (ORDER BY DT ASC) AS BUSDAY
    FROM
        (
        SELECT
            DT,
            TO_CHAR(DT,'d') AS DOTW
        FROM
            (
            SELECT
                TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+""")) - (ROWNUM-1)) DT
            FROM
                DUAL CONNECT BY ROWNUM < 365
            ) FST
        ORDER BY DT ASC
        ) SND
    LEFT JOIN
        SBO_MASTER.HOLIDAY HOL ON HOL.holiday_date = SND.DT
    WHERE
	   (HOL.holiday_date IS NULL
		OR HOL.HOLIDAY_NAME LIKE 'PRESIDENT%'
		OR HOL.HOLIDAY_NAME LIKE 'JUNETEENTH%'
		OR HOL.HOLIDAY_NAME LIKE 'COLUMBUS%')
        AND SND.DOTW NOT IN (1,7)
        AND DT BETWEEN ADD_MONTHS(TRUNC(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""),'MONTH'),0) AND LAST_DAY(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""))
    ) THRD
WHERE BUSDAY = 7 
) AS SBO_INV_CUTOFF_DATE_CURRENT,
(SELECT
    DT
FROM
    (
    SELECT
        DT,
        ROW_NUMBER() OVER (ORDER BY DT ASC) AS BUSDAY
    FROM
        (
        SELECT
            DT,
            TO_CHAR(DT,'d') AS DOTW
        FROM
            (
            SELECT
                TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+""")) - (ROWNUM-1)) DT
            FROM
                DUAL CONNECT BY ROWNUM < 365
            ) FST
        ORDER BY DT ASC
        ) SND
    LEFT JOIN
        SBO_MASTER.HOLIDAY HOL ON HOL.holiday_date = SND.DT
    WHERE
	   (HOL.holiday_date IS NULL
		OR HOL.HOLIDAY_NAME LIKE 'PRESIDENT%'
		OR HOL.HOLIDAY_NAME LIKE 'JUNETEENTH%'
		OR HOL.HOLIDAY_NAME LIKE 'COLUMBUS%')
        AND SND.DOTW NOT IN (1,7)
        AND DT BETWEEN ADD_MONTHS(TRUNC(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""),'MONTH'),-1) AND LAST_DAY(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""))
    ) THRD
WHERE BUSDAY = 7 
) AS SBO_INV_CUTOFF_DATE_PRIOR,
	LAST_DAY(ADD_MONTHS(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""),-1)) AS MONTHEND_CYCLE_DATE,
	ADD_MONTHS(TRUNC(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""),'MONTH'),-1) AS BEGIN_CYCLE_DATE,
	ADD_MONTHS(SYSDATE,"""+adhocmonthsback+""") AS CURRENT_DATE,
	TRUNC(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+"""),'MONTH') AS BEGIN_DISTRIBUTION_MNTH_DATE,
	LAST_DAY(ADD_MONTHS(SYSDATE,"""+adhocmonthsback+""")) AS END_DISTRIBUTION_MNTH_DATE
FROM DUAL
)
/*
REQUIRED TABLES
=======================================================
NOTE: These tables are added for testing purposes.  They have been submitted to DM and are available on the DM_ETL schema
=======================================================
*/
		   


,tbl_AAR_Pools 
(
	AAR_Client,
	COMP_INT_TYPE_CODE,
	DSCR,
	RFC_Deal_Series,
	RFC_DDS_Deal_ID,
	INV_CUSTNO,
	CUSTNAME,
	GLACT_CASH,
	RFC_Actual_Pool_ID,
	Class_Seq_ID,
	Class_Name,
	Determination_Day,
	Deal_First_Determ_Date,
	Deal_Closing_Date,
	Neg_Amort_Allowed,
	Real_Time_Payoff_Seq_ID,
	Determ_Delq_Type_Code,
	First_Reporting_Cycle,
	Default_Reporting,
	Pool_Insurance,
	AAR_CONTROL_REMIT_TYPE,
	Adv_To_Liq_Ind,
	MASTER_SALE_CONTROL_REMIT_TYPE
)
AS
(
SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','1993-WH2','778','7259','Wells Fargo','CUWF1','3177','16242','','20','04/20/1993',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','2001-CWH1','7092','7260','Wells Fargo','CUWF2','3490','17129','','20','02/20/2001',NULL,'FALSE','','','200704','FALSE','','3','Y','3' FROM DUAL
UNION SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','2001-PTWH19','9340','7210','Bayview Financial Trading/Wells Fargo','CUBAYVIEWWELLS','3544','','','20','12/20/2001',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','2004-NWH1','15020','7210','Bayview Financial Trading/Wells Fargo','CUBAYVIEWWELLS','3729','','','20','07/20/2004',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','2001-PTWH16','9180','7210','Bayview Financial Trading/Wells Fargo','CUBAYVIEWWELLS','3779','','','20','10/20/2001',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','1','NO COMPENSATING INTEREST','2004-PTWH13','15864','7210','Bayview Financial Trading/Wells Fargo','CUBAYVIEWWELLS','3780','','','20','01/20/2005',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-WH15','16463','7214','Bank of America Mortgage / Wells Fargo','CUBOFAWELLS1','3785','47012','3785','15','05/16/2005','04/28/2005','FALSE','','MBA','200505','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-GSR-AR7','17302','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3810','','','15','10/16/2005',NULL,'FALSE','','','200704','FALSE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-WH28B','17480','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3811','','','15','11/16/2005',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-WH32','17800','7248','PNC/Wells Fargo','CUPNCWF','3827','','','16','01/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-QWH13','17780','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3832','','','15','01/15/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-WH1','17903','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3838','','','15','02/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-WH1','17903','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3839','','','15','02/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-LUM-3','18123','7108','WELLS FARGO/LUMINENT CAPITAL','CUWFLC06LUM-3','3850','','','15','04/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-LUM-3','18123','7108','WELLS FARGO/LUMINENT CAPITAL','CUWFLC06LUM-3','3851','','','15','04/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-WH17','18782','7248','PNC/Wells Fargo','CUPNCWF','3880','','','16','08/16/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-WH21','19365','7254','UBS/Wells Fargo','CUUBSWF','3939','','','15','11/15/2006',NULL,'FALSE','','','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2007-GSR-AR1','19661','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3945','52788','3945','15','01/16/2007','12/28/2006','FALSE','','MBA','200704','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2007-GSR-AR1','19961','7236','Goldman Sachs Mortgage/Wells Fargo','CUGOLDMANMTGWF','3946','52808','3946','15','12/28/2006','01/16/2007','FALSE','','MBA','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2007-DBALT-RAMP1','20400','7107','WELLS FARGO/DEUTSCHE BANK','CUWFDB07RAMP1','3964','','','15','03/15/2007',NULL,'FALSE','','OTS','200704','TRUE','','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-BAFC-4','21260','7214','Bank of America Mortgage / Wells Fargo','CUBOFAWELLS','3980','55908','3980','15','06/16/2007','08/29/2005','FALSE','','MBA','200706','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-BAFC-5','21261','7214','Bank of America Mortgage / Wells Fargo','CUBOFAWELLS','3981','55928','3981','15','06/16/2007','08/29/2005','FALSE','','MBA','200706','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-BAFC-6','21263','7214','Bank of America Mortgage / Wells Fargo','CUBOFAWELLS','3983','55968','3983','15','06/16/2007','10/29/2006','FALSE','','MBA','200706','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2005-BAFC-8','21281','7214','Bank of America Mortgage / Wells Fargo','CUBOFAWELLS','3985','56008','3985','15','06/15/2007','12/29/2005','FALSE','','MBA','200706','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2007-DLJMC-HCSB','22300','7126','Wells Fargo / M||CHR(38)||T','CUWFDB','30001','','30001','20','12/20/2007','11/20/2007','FALSE','','MBA','200712','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2007-DLJMC-HCSB','22300','7126','Wells Fargo / M||CHR(38)||T','CUWFDB','30002','','30002','20','12/20/2007','11/20/2007','FALSE','','MBA','200712','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
UNION SELECT 'Wells Fargo','2','COMPENSATING INTEREST - NO CROSS COMP','2006-DBALT-AR1','22360','7107','WELLS FARGO/DEUTSCHE BANK','CUWFDB','30004','','30004','15','12/15/2007','12/01/2007','FALSE','','MBA','200712','TRUE','NO INSURANCE REQUIRED','3','','3' FROM DUAL
)

,tbl_Wells_Inv_Numbers
(
RFC_Loan_Nbr,
Loan_Nbr
)
AS
(
SELECT 4690538,166681 FROM DUAL
UNION SELECT 4690332,166684 FROM DUAL
UNION SELECT 4129463,166688 FROM DUAL
UNION SELECT 4129851,166689 FROM DUAL
UNION SELECT 4690385,166712 FROM DUAL
UNION SELECT 4690312,166739 FROM DUAL
UNION SELECT 4690265,166744 FROM DUAL
UNION SELECT 4690651,166755 FROM DUAL
UNION SELECT 4690243,166761 FROM DUAL
UNION SELECT 4690242,166762 FROM DUAL
UNION SELECT 4130574,166775 FROM DUAL
UNION SELECT 4689641,166776 FROM DUAL
UNION SELECT 4353246,166794 FROM DUAL
UNION SELECT 4491599,166811 FROM DUAL
UNION SELECT 4689649,166840 FROM DUAL
UNION SELECT 4690446,166841 FROM DUAL
UNION SELECT 4130102,166859 FROM DUAL
UNION SELECT 4130035,166864 FROM DUAL
UNION SELECT 4130318,166869 FROM DUAL
UNION SELECT 4690124,166880 FROM DUAL
UNION SELECT 4130611,166887 FROM DUAL
UNION SELECT 4129290,166901 FROM DUAL
UNION SELECT 4510120,166940 FROM DUAL
UNION SELECT 4690452,166995 FROM DUAL
UNION SELECT 4690324,167009 FROM DUAL
UNION SELECT 4510025,167020 FROM DUAL
UNION SELECT 4690406,167033 FROM DUAL
UNION SELECT 4491582,178187 FROM DUAL
UNION SELECT 5124550,178189 FROM DUAL
UNION SELECT 4690432,178191 FROM DUAL
UNION SELECT 4491589,178192 FROM DUAL
UNION SELECT 4689658,178194 FROM DUAL
UNION SELECT 4491566,178195 FROM DUAL
UNION SELECT 5128391,178196 FROM DUAL
UNION SELECT 4689680,178198 FROM DUAL
UNION SELECT 5123716,178202 FROM DUAL
UNION SELECT 4689103,178208 FROM DUAL
UNION SELECT 4130428,178209 FROM DUAL
UNION SELECT 4130085,178216 FROM DUAL
UNION SELECT 4129682,178217 FROM DUAL
UNION SELECT 4690104,178231 FROM DUAL
UNION SELECT 4129074,178239 FROM DUAL
UNION SELECT 4359604,178243 FROM DUAL
UNION SELECT 4129070,178249 FROM DUAL
UNION SELECT 4129071,178251 FROM DUAL
UNION SELECT 4491583,178267 FROM DUAL
UNION SELECT 4689104,178287 FROM DUAL
UNION SELECT 4129847,178288 FROM DUAL
UNION SELECT 4690443,178293 FROM DUAL
UNION SELECT 4690386,178306 FROM DUAL
UNION SELECT 4130116,178310 FROM DUAL
UNION SELECT 1511221,283100 FROM DUAL
UNION SELECT 1517269,283108 FROM DUAL
UNION SELECT 1510857,283112 FROM DUAL
UNION SELECT 1510250,283115 FROM DUAL
UNION SELECT 1517516,283116 FROM DUAL
UNION SELECT 1517260,283118 FROM DUAL
UNION SELECT 1510775,283119 FROM DUAL
UNION SELECT 1510200,283127 FROM DUAL
UNION SELECT 1510693,283129 FROM DUAL
UNION SELECT 1420739,283130 FROM DUAL
UNION SELECT 1510146,283134 FROM DUAL
UNION SELECT 1510991,283135 FROM DUAL
UNION SELECT 1510751,283138 FROM DUAL
UNION SELECT 1510846,283139 FROM DUAL
UNION SELECT 1510506,283141 FROM DUAL
UNION SELECT 1511150,283150 FROM DUAL
UNION SELECT 1510778,283152 FROM DUAL
UNION SELECT 1510428,283155 FROM DUAL
UNION SELECT 1510290,283156 FROM DUAL
UNION SELECT 1510624,283157 FROM DUAL
UNION SELECT 1449799,283158 FROM DUAL
UNION SELECT 1510999,283161 FROM DUAL
UNION SELECT 1510716,283162 FROM DUAL
UNION SELECT 1510034,283163 FROM DUAL
UNION SELECT 7333162,283166 FROM DUAL
UNION SELECT 1773700,283171 FROM DUAL
UNION SELECT 1510245,283173 FROM DUAL
UNION SELECT 1510886,283174 FROM DUAL
UNION SELECT 1510333,283175 FROM DUAL
UNION SELECT 1510350,283176 FROM DUAL
UNION SELECT 1510486,283177 FROM DUAL
UNION SELECT 1510306,283188 FROM DUAL
UNION SELECT 1510621,283189 FROM DUAL
UNION SELECT 1510799,283190 FROM DUAL
UNION SELECT 1510720,283194 FROM DUAL
UNION SELECT 1420747,283196 FROM DUAL
UNION SELECT 1510977,283198 FROM DUAL
UNION SELECT 1510227,283200 FROM DUAL
UNION SELECT 1510422,283201 FROM DUAL
UNION SELECT 1510183,283203 FROM DUAL
UNION SELECT 1510864,283205 FROM DUAL
UNION SELECT 1439414,283215 FROM DUAL
UNION SELECT 1421254,283216 FROM DUAL
UNION SELECT 1510669,283219 FROM DUAL
UNION SELECT 1511001,283221 FROM DUAL
UNION SELECT 1510481,283225 FROM DUAL
UNION SELECT 1510830,283226 FROM DUAL
UNION SELECT 1510046,283231 FROM DUAL
UNION SELECT 1510255,283232 FROM DUAL
UNION SELECT 1510897,283233 FROM DUAL
UNION SELECT 1510801,283234 FROM DUAL
UNION SELECT 1511030,283236 FROM DUAL
UNION SELECT 1510372,283237 FROM DUAL
UNION SELECT 1511133,283239 FROM DUAL
UNION SELECT 1511215,283248 FROM DUAL
UNION SELECT 1510300,283251 FROM DUAL
UNION SELECT 1511191,283253 FROM DUAL
UNION SELECT 1510079,283254 FROM DUAL
UNION SELECT 1510288,283259 FROM DUAL
UNION SELECT 1510763,283266 FROM DUAL
UNION SELECT 1510215,283267 FROM DUAL
UNION SELECT 1510684,283271 FROM DUAL
UNION SELECT 1510544,283279 FROM DUAL
UNION SELECT 1510873,283280 FROM DUAL
UNION SELECT 1437697,283281 FROM DUAL
UNION SELECT 1510769,283286 FROM DUAL
UNION SELECT 1510838,283292 FROM DUAL
UNION SELECT 1401146,283300 FROM DUAL
UNION SELECT 1851887,283302 FROM DUAL
UNION SELECT 1510158,283306 FROM DUAL
UNION SELECT 1493672,283310 FROM DUAL
UNION SELECT 7551174,283311 FROM DUAL
UNION SELECT 1510894,283312 FROM DUAL
UNION SELECT 1510381,283313 FROM DUAL
UNION SELECT 8706437,291278 FROM DUAL
UNION SELECT 8706347,291285 FROM DUAL
UNION SELECT 1907588,620466 FROM DUAL
UNION SELECT 2863967,620470 FROM DUAL
)

,Wells_Interest_Adjustments
(
LOAN_NUMBER,
INT_ADJ_AMT,
REASON_DESCRIPTION
)
AS
(
"""+etlscript+"""
)
/*
00_Get_Prior_IRH_Data = QUERY_002
=======================================================
NOTE: 0_IRH_Data_Prior
=======================================================
*/
,QUERY_002 AS
(
SELECT
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_CUSTNO,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_NUMBER,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_DUE_DATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_STATUS_DATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.REO_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_ADVANCING_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_NOTE_RATE ,
	CASE
		WHEN sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PART_PRINCIPAL -sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL <=0
		THEN 0
		ELSE sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PART_PRINCIPAL -sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL 
	END AS END_SCHED_PART_PRINCIPAL ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PMT_AMT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PRINCIPAL ,
	CASE
		WHEN sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_PARTICIPANT_PRINCIPAL-sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL <=0
		THEN 0
		ELSE sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_PARTICIPANT_PRINCIPAL-sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL 
	END AS LOAN_PARTICIPANT_PRINCIPAL,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_INTEREST_ADVANCED ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_INVESTOR_BALANCE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_NOTE_RATE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_PMT_AMT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_SVC_FEE_RATE ,
	NVL(sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL,0) AS DEFRD_PART_PRINCIPAL 
FROM
	VARIABLES,
	sbo_master.INVESTOR_REMITTANCE_HISTORY
WHERE
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE =VARIABLES.SBO_Inv_Cutoff_Date_Prior
	AND sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_CUSTNO In (7107,7108,7210,7214,7236,7248,7254,7259,7260,7110)
)




/*
1_Get_IRH_Data1 = QUERY_003
=======================================================
NOTE: 1_IRH_Data_0
=======================================================
*/

,QUERY_003 AS
(
SELECT
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE ,
	VARIABLES.Monthend_Cycle_Date AS ACCT_CYCLE_MONTHEND_DATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_CUSTNO,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_NUMBER,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_STATUS_DATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.REO_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_ADVANCING_STATUS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_NOTE_RATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_NOTE_RATE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_PAYMENT_AMOUNT,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PMT_AMT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.ADDITIONAL_PRINCIPAL_COLLECTED,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_ADJUSTMENTS,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_INVESTOR_BALANCE -QUERY_002.DEFRD_PART_PRINCIPAL  AS BGN_INVESTOR_BALANCE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_NOTE_RATE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_PMT_AMT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.BGN_SCHED_INV_SVC_FEE_RATE ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_DUE_DATE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.DELINQUENT_INTEREST,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.DELINQUENT_PRINCIPAL,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.DELINQUENT_SVC_FEE  ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV+sbo_master.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED+sbo_master.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED AS IRH_total,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.PASS_THRU_INTEREST_EXPENSE,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_LOAN_NUMBER,
	CASE
		WHEN sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_PARTICIPANT_PRINCIPAL-sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL <=0
		THEN 0
		ELSE sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_PARTICIPANT_PRINCIPAL-sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL 
	END AS LOAN_PARTICIPANT_PRINCIPAL,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_PREPAY_REMITTED_INV,
	CASE
		WHEN sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PART_PRINCIPAL -sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL <=0
		THEN 0
		ELSE sbo_master.INVESTOR_REMITTANCE_HISTORY.END_SCHED_PART_PRINCIPAL -sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL 
	END AS END_SCHED_PART_PRINCIPAL ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LAST_MODIFIED_BY_USER,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.SCHED_INTEREST_AMOUNT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.SCHED_PRINCIPAL_AMOUNT ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.SCHED_SVC_FEE_AMOUNT  ,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.REO_BACKED_OUT_SCHED_INTEREST,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.REO_BACKED_OUT_SCHED_PRINCIPAL,
	sbo_master.INVESTOR_REMITTANCE_HISTORY.DEFRD_PART_PRINCIPAL 
FROM
	VARIABLES,
	sbo_master.INVESTOR_REMITTANCE_HISTORY
LEFT JOIN
	QUERY_002 ON sbo_master.INVESTOR_REMITTANCE_HISTORY.LOAN_NUMBER = QUERY_002.LOAN_NUMBER
WHERE
	sbo_master.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE =VARIABLES.SBO_Inv_Cutoff_Date_Current
	AND sbo_master.INVESTOR_REMITTANCE_HISTORY.INVESTOR_CUSTNO In (7107,7108,7210,7214,7236,7248,7254,7259,7260,7110)
)

/*
1_Get_IRH_Data1a = QUERY_004
=======================================================
NOTE: query included in QUERY_003 FROM
	Left join on QUERY_2
=======================================================
*/
/*

UPDATE
	QUERY_003
INNER JOIN
	QUERY_002 ON QUERY_003.LOAN_NUMBER = QUERY_002.LOAN_NUMBER
SET
	QUERY_003.BGN_INVESTOR_BALANCE = QUERY_003.BGN_INVESTOR_BALANCE-QUERY_002.DEFERRED_PART_PRINCIPAL;


*/



/*
1_Get_IRH_Data2 = QUERY_005
=======================================================
NOTE: 1_IRH_Data
=======================================================
*/
,QUERY_005 AS
(
SELECT
	QUERY_003.last_investor_cutoff_date,
	QUERY_003.ACCT_CYCLE_MONTHEND_DATE,
	QUERY_003.LOAN_NUMBER,
	QUERY_003.LOAN_STATUS,
	QUERY_003.LOAN_STATUS_DATE,
	QUERY_003.REO_STATUS,
	QUERY_003.INVESTOR_ADVANCING_STATUS,
	QUERY_003.LOAN_NOTE_RATE,
	QUERY_003.END_SCHED_NOTE_RATE,
	QUERY_003.LOAN_PAYMENT_AMOUNT,
	QUERY_003.END_SCHED_PMT_AMT,
	QUERY_003.ADDITIONAL_PRINCIPAL_COLLECTED,
	QUERY_003.PRINCIPAL_ADJUSTMENTS,
	QUERY_003.ANCILLARY_FEES_REMITTED_INV,
	QUERY_003.PRINCIPAL_REMITTED,
	QUERY_003.INTEREST_REMITTED,
	QUERY_003.BGN_INVESTOR_BALANCE,
	QUERY_003.BGN_SCHED_INV_NOTE_RATE,
	QUERY_003.BGN_SCHED_INV_PMT_AMT,
	QUERY_003.BGN_SCHED_INV_SVC_FEE_RATE,
	QUERY_003.LOAN_DUE_DATE,
	QUERY_003.DELINQUENT_INTEREST,
	QUERY_003.DELINQUENT_PRINCIPAL,
	QUERY_003.DELINQUENT_SVC_FEE,
	QUERY_003.PRINCIPAL_REMITTED+QUERY_003.INTEREST_REMITTED+QUERY_003.ANCILLARY_FEES_REMITTED_INV AS IRH_total,
	QUERY_003.PASS_THRU_INTEREST_EXPENSE,
	QUERY_003.INVESTOR_CUSTNO,
	QUERY_003.SALE_NUMBER,
	QUERY_003.INVESTOR_LOAN_NUMBER,
	QUERY_003.LOAN_PARTICIPANT_PRINCIPAL,
	QUERY_003.ANCILLARY_PREPAY_REMITTED_INV,
	QUERY_003.END_SCHED_PART_PRINCIPAL,
	QUERY_003.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	tbl_AAR_Pools.Determination_Day,
	tbl_AAR_Pools.COMP_INT_TYPE_CODE,
	tbl_AAR_Pools.DSCR,
	tbl_AAR_Pools.CUSTNAME,
	QUERY_003.LAST_MODIFIED_BY_USER,
	QUERY_003.sched_interest_amount,
	QUERY_003.SCHED_PRINCIPAL_AMOUNT,
	QUERY_003.SCHED_SVC_FEE_AMOUNT,
	QUERY_003.REO_BACKED_OUT_SCHED_INTEREST,
	QUERY_003.REO_BACKED_OUT_SCHED_PRINCIPAL,
	QUERY_003.DEFRD_PART_PRINCIPAL
FROM
	QUERY_003
LEFT JOIN
	tbl_AAR_Pools ON QUERY_003.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_003.LOAN_NUMBER = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr

/*
1a_Get_Loan_Mast_Info = QUERY_006
=======================================================
NOTE: 1a_Loan_Mast_Info
=======================================================
*/								 
),QUERY_006 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	QUERY_005.LOAN_STATUS,
	sbo_master.loan_accounting.LOAN_NUMBER,
	sbo_master.loan_user.MODIFICATION_REASON_CODE,
	sbo_master.loan_accounting.LAST_RATE_CHANGE_DATE RATE_LAST_CHANGE,
	sbo_master.loan_accounting.NEXT_RATE_CHANGE_DATE RATE_NEXT_CHANGE,
	sbo_master.loan_accounting.SALE_NET_INT_ADV,
	sbo_master.loan_accounting.SALE_PRINCIPAL_ADV,
	sbo_master.loan_accounting.ACCRUED_FEES,
	sbo_master.loan_accounting.LAST_PART_NOTE_INT_ADV,
	sbo_master.loan_accounting.LAST_PART_SVC_FEE_ADV LAST_PART_SERV_FEE_ADV,
	sbo_master.loan_accounting.LAST_PART_PRIN_ADV,
	sbo_master.loan_accounting.REO_PROPERTY_NUMBER,
	sbo_master.loan_accounting.REO_STATUS_DATE,
	CASE
		WHEN sbo_master.lOAN_accounting.REO_STATUS_DATE Is Not Null
		THEN LAST_DAY(sbo_master.loan_accounting.REO_STATUS_DATE)--ORIG: DateSerial(Year(sbo_master.loan_accounting.REO_STATUS_DATE),Month(sbo_master.loan_accounting.REO_STATUS_DATE)+1,0)
		ELSE NULL
	END AS REO_MNTHEND_DATE,
	sbo_MASTER.CUSTOMER.CUSTNAME,
	
	sbo_master.loan_accounting.SERVICER_LOAN_NUMBER,
	QUERY_005.LAST_MODIFIED_BY_USER,
	sbo_master.loan_accounting.SERVICER_SVC_FEE_RATE PUR_CURRENT_SERVICE_FEE_RATE,
	sbo_master.loan_accounting.END_SCHED_PMT_AMT LAST_SCHED_PMT_AMT
FROM
	QUERY_005
LEFT JOIN
	sbo_master.loan_accounting ON QUERY_005.RFC_Loan_Nbr = sbo_master.loan_accounting.LOAN_NUMBER
    left join 
    sbo_master.loan_user ON QUERY_005.RFC_Loan_Nbr = sbo_master.loan_user.LOAN_NUMBER
LEFT JOIN
	sbo_MASTER.CUSTOMER ON sbo_master.loan_accounting.SERVICER_CUSTNO = sbo_MASTER.CUSTOMER.CUSTNO
)

/*
1b_get_IndexValues = QUERY_007
=======================================================
NOTE: 1b_Index_Rates
=======================================================
*/


,QUERY_007 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	sbo_MASTER.RATEHIST.rate_effective_date EFFECTIVE_DATE,
	QUERY_006.RATE_LAST_CHANGE,
	QUERY_006.RATE_NEXT_CHANGE,
	sbo_MASTER.RATEHIST.INDEX_PUBLISHED_DATE,
	sbo_MASTER.RATEHIST.PUBLISHED_INDEX_VALUE
FROM
	QUERY_005
LEFT JOIN
	QUERY_006
LEFT JOIN
	sbo_MASTER.RATEHIST ON QUERY_006.LOAN_NUMBER = sbo_MASTER.RATEHIST.LOAN_NUMBER ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
ORDER BY
	QUERY_005.RFC_Loan_Nbr,
	sbo_MASTER.RATEHIST.rate_EFFECTIVE_DATE DESC
)

/*
1b_get_IndexValues2 = QUERY_008
=======================================================
NOTE: 1b_Index_Rates2
=======================================================
*/

,QUERY_008 AS
(
SELECT
	QUERY_007.RFC_Loan_Nbr,
	QUERY_007.EFFECTIVE_DATE,
	QUERY_007.RATE_LAST_CHANGE,
	QUERY_007.RATE_NEXT_CHANGE,
	QUERY_007.INDEX_PUBLISHED_DATE,
	QUERY_007.PUBLISHED_INDEX_VALUE
FROM
	QUERY_007,
	VARIABLES
WHERE
	QUERY_007.EFFECTIVE_DATE<VARIABLES.Begin_Distribution_Mnth_Date
)







/*
1bb_Get_Index_Rates3 = QUERY_009
=======================================================
NOTE: 1bb_Index_Rates
=======================================================
*/
/*ORIG QUERY:
,QUERY_009 AS
(
SELECT
	QUERY_008.RFC_Loan_Nbr,
	First(QUERY_008.EFFECTIVE_DATE) AS EFFECTIVE_DATE,
	First(QUERY_008.RATE_LAST_CHANGE) AS RATE_LAST_CHANGE,
	First(QUERY_008.RATE_NEXT_CHANGE) AS RATE_NEXT_CHANGE,
	First(QUERY_008.INDEX_PUBLISHED_DATE) AS INDEX_PUBLISHED_DATE,
	First(QUERY_008.PUBLISHED_INDEX_VALUE) AS PUBLISHED_INDEX_VALUE
FROM
	QUERY_008
GROUP BY
	QUERY_008.RFC_Loan_Nbr
)*/

,QUERY_009 AS
(
SELECT
    RFC_LOAN_NBR,
    EFFECTIVE_DATE,
    RATE_LAST_CHANGE,
    RATE_NEXT_CHANGE,
    INDEX_PUBLISHED_DATE,
    PUBLISHED_INDEX_VALUE
FROM
    (
    SELECT
        QUERY_008.RFC_Loan_Nbr,
        QUERY_008.EFFECTIVE_DATE AS EFFECTIVE_DATE,
        QUERY_008.RATE_LAST_CHANGE AS RATE_LAST_CHANGE,
        QUERY_008.RATE_NEXT_CHANGE AS RATE_NEXT_CHANGE,
        QUERY_008.INDEX_PUBLISHED_DATE AS INDEX_PUBLISHED_DATE,
        QUERY_008.PUBLISHED_INDEX_VALUE AS PUBLISHED_INDEX_VALUE,
        ROW_NUMBER() OVER (PARTITION BY QUERY_008.RFC_Loan_Nbr ORDER BY QUERY_008.EFFECTIVE_DATE DESC) AS FIRSTNUM
    FROM
        QUERY_008
    ) FST
WHERE
	FST.FIRSTNUM = 1
)






/*
1bbb_update_LPMI_loans = QUERY_010
=======================================================
NOTE: tbl LPMI_Rates
=======================================================
*/

,QUERY_010 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr AS LOAN_NUMBER,
	0.67 AS LPMI_RATE,
	CASE
        WHEN QUERY_005.INVESTOR_ADVANCING_STATUS='Y'
        THEN QUERY_005.INVESTOR_ADVANCING_STATUS
        ELSE NULL
    END AS INVESTOR_ADVANCING_STATUS,
    CASE
        WHEN QUERY_005.INVESTOR_ADVANCING_STATUS='Y'
        THEN QUERY_005.BGN_INVESTOR_BALANCE
        ELSE NULL
    END AS BEGINNING_INVESTOR_BALANCE
FROM
	QUERY_005
WHERE
    QUERY_005.RFC_Loan_Nbr IN (4129070,4129074,4129290,4129463,4130085,4130102,4130116,4130318,4130428,4130574,4130611)
)



/*
1bbbb_Calc_LPMI_Loans = QUERY_011
=======================================================
NOTE: 1bbbb_LPMI_Amts
=======================================================
*/
,QUERY_011 AS
(
SELECT
	QUERY_010.LOAN_NUMBER,
	QUERY_010.LPMI_RATE,
	QUERY_005.INVESTOR_ADVANCING_STATUS,
	QUERY_005.BGN_INVESTOR_BALANCE
 BEGINNING_INVESTOR_BALANCE,
	ROUND(QUERY_005.BGN_INVESTOR_BALANCE*QUERY_010.LPMI_RATE/1200,2) AS LPMI_Amt,
	QUERY_005.REO_STATUS
FROM
	QUERY_010
LEFT JOIN
	QUERY_005 ON QUERY_010.LOAN_NUMBER = QUERY_005.LOAN_NUMBER
WHERE
	QUERY_005.INVESTOR_ADVANCING_STATUS='Y'
)




/*
1c_Get_Liq_Reversal = QUERY_012
=======================================================
NOTE: 1c_LiqReversal
=======================================================
*/

,QUERY_012 AS
(
SELECT
	VARIABLES.Monthend_Cycle_Date AS ACCT_CYCLE_MONTHEND_DATE,
	QUERY_006.RFC_Loan_Nbr,
	QUERY_006.LOAN_STATUS,
	QUERY_006.LOAN_NUMBER,
	QUERY_006.MODIFICATION_REASON_CODE,
	QUERY_006.RATE_LAST_CHANGE,
	QUERY_006.RATE_NEXT_CHANGE,
	QUERY_006.SALE_NET_INT_ADV,
	QUERY_006.SALE_PRINCIPAL_ADV,
	QUERY_006.ACCRUED_FEES,
	QUERY_006.LAST_PART_NOTE_INT_ADV,
	QUERY_006.LAST_PART_SERV_FEE_ADV,
	QUERY_006.LAST_PART_PRIN_ADV,
	QUERY_006.REO_PROPERTY_NUMBER,
	QUERY_006.REO_STATUS_DATE,
	QUERY_006.REO_MNTHEND_DATE,
	QUERY_006.CUSTNAME,
	QUERY_006.SERVICER_LOAN_NUMBER,
	QUERY_006.LAST_MODIFIED_BY_USER
FROM
	QUERY_006,
	VARIABLES
WHERE
	QUERY_006.LAST_MODIFIED_BY_USER Like 'CLU(LIQREVERSE)'
)

/*
1cc_Get_Delinq_PI_Advances = QUERY_013
=======================================================
NOTE: 1cc_Delinq_PI_Advances
=======================================================
*/



,QUERY_013 AS
(
SELECT
	QUERY_005.LOAN_NUMBER,
	QUERY_005.LOAN_STATUS,
	CASE
		WHEN QUERY_005.LOAN_DUE_DATE<VARIABLES.Begin_Cycle_Date
		THEN QUERY_005.INTEREST_REMITTED+QUERY_005.PRINCIPAL_REMITTED
		ELSE 0
	END AS Delinq_PI_Advance_Amt,
	QUERY_005.LOAN_DUE_DATE,
	QUERY_005.PRINCIPAL_REMITTED,
	QUERY_005.INTEREST_REMITTED,
	QUERY_005.INVESTOR_ADVANCING_STATUS
FROM
	QUERY_005,
	VARIABLES
WHERE
	QUERY_005.LOAN_STATUS='1'
	AND QUERY_005.INVESTOR_ADVANCING_STATUS='Y'
)







/*
1d_get_SBO_RateMods0 = QUERY_014
=======================================================
NOTE: 1d_SBORateMods0
=======================================================
*/


,QUERY_014 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	QUERY_005.LOAN_STATUS,
	sbo_master.loan_mod_history.LOAN_NUMBER,
	sbo_master.loan_mod_history.old_MODIFICATION_CODE BEFORE_MODIFICATION_CODE,
	sbo_master.loan_mod_history.MODIFICATION_CODE,
	sbo_master.loan_mod_history.MOD_EFFECTIVE_DATE,
	sbo_master.loan_mod_history.MOD_NUMBER,
	sbo_master.loan_mod_history.MOD_REVERSAL_REASON_CODE,
	QUERY_005.BGN_SCHED_INV_NOTE_RATE BEGINNING_INVESTOR_NOTE_RATE,
	sbo_master.loan_mod_history.NEW_LOAN_NOTE_RATE AFTER_LOAN_NOTE_RATE,
	sbo_master.loan_mod_history.OLD_SALE_SCHED_NOTE_RATE BEFORE_SALE_SCHED_NOTE_RATE,
	sbo_master.loan_mod_history.CAPITALIZED_TOTAL,
	sbo_master.loan_mod_history.OLD_SALE_SCHED_NOTE_RATE-QUERY_005.BGN_SCHED_INV_NOTE_RATE AS Rate_Diff,
	CASE
		WHEN sbo_master.loan_mod_history.DEFRD_PRINCIPAL
 Is Null
		THEN 0
		ELSE sbo_master.loan_mod_history.DEFRD_PRINCIPAL

	END AS DEFERRED_PRINCIPAL,
	sbo_master.loan_mod_history.MOD_RATE_EFFECTIVE_DATE,
	QUERY_006.MODIFICATION_REASON_CODE AS MODIFICATION_REASON_CODE_LM,
	sbo_master.loan_mod_history.LAST_UPDATE_DATE DATE_OF_LAST_UPDATE
FROM
	QUERY_005
LEFT JOIN
	sbo_master.loan_mod_history ON QUERY_005.RFC_Loan_Nbr = sbo_master.loan_mod_history.LOAN_NUMBER
LEFT JOIN
	QUERY_006 ON QUERY_005.LOAN_NUMBER = QUERY_006.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS='1'
	AND sbo_master.loan_mod_history.LOAN_NUMBER Is Not Null
	AND sbo_master.loan_mod_history.MOD_NUMBER Not Like '*.*'
	AND sbo_master.loan_mod_history.MOD_REVERSAL_REASON_CODE Is Null
ORDER BY
	QUERY_005.RFC_Loan_Nbr,
	sbo_master.loan_mod_history.MOD_NUMBER
)

/*
1d_get_SBO_RateMods00 = QUERY_015
=======================================================
NOTE: 1d_SBORateMods00
=======================================================
*/

,QUERY_015 AS
(
SELECT
	QUERY_014.RFC_Loan_Nbr,
	QUERY_014.LOAN_STATUS,
	QUERY_014.LOAN_NUMBER,
	QUERY_014.BEFORE_MODIFICATION_CODE,
	QUERY_014.MODIFICATION_CODE,
	QUERY_014.MOD_EFFECTIVE_DATE,
	QUERY_014.MOD_NUMBER,
	QUERY_014.MOD_REVERSAL_REASON_CODE,
	QUERY_014.BEGINNING_INVESTOR_NOTE_RATE,
	QUERY_014.AFTER_LOAN_NOTE_RATE,
	QUERY_014.BEFORE_SALE_SCHED_NOTE_RATE,
	QUERY_014.CAPITALIZED_TOTAL,
	QUERY_014.Rate_Diff,
	QUERY_014.DEFERRED_PRINCIPAL,
	QUERY_014.MOD_RATE_EFFECTIVE_DATE,
	QUERY_014.MODIFICATION_REASON_CODE_LM,
	QUERY_014.DATE_OF_LAST_UPDATE
FROM
	VARIABLES,
	QUERY_014
WHERE
	QUERY_014.MOD_RATE_EFFECTIVE_DATE<VARIABLES.Begin_Distribution_Mnth_Date
ORDER BY
	QUERY_014.RFC_Loan_Nbr,
	QUERY_014.MOD_NUMBER
)






/*
1d_get_SBO_RateMods1 = QUERY_016
=======================================================
NOTE: 1d_SBORateMods
=======================================================
*/
/*ORIG QUERY:
,QUERY_016 AS
(
SELECT
	QUERY_014.RFC_Loan_Nbr,
	Last(QUERY_014.LOAN_STATUS) AS LOAN_STATUS,
	Last(QUERY_014.LOAN_NUMBER) AS LOAN_NUMBER,
	Last(QUERY_014.BEFORE_MODIFICATION_CODE) AS BEFORE_MODIFICATION_CODE,
	Last(QUERY_014.MODIFICATION_CODE) AS MODIFICATION_CODE,
	Last(QUERY_014.MOD_EFFECTIVE_DATE) AS MOD_EFFECTIVE_DATE,
	Last(QUERY_014.MOD_NUMBER) AS MOD_NUMBER,
	Last(QUERY_014.MOD_REVERSAL_REASON_CODE) AS MOD_REVERSAL_REASON_CODE,
	Last(QUERY_014.BEGINNING_INVESTOR_NOTE_RATE) AS BEGINNING_INVESTOR_NOTE_RATE,
	Last(QUERY_014.AFTER_LOAN_NOTE_RATE) AS AFTER_LOAN_NOTE_RATE,
	Last(QUERY_014.BEFORE_SALE_SCHED_NOTE_RATE) AS BEFORE_SALE_SCHED_NOTE_RATE,
	Last(QUERY_014.CAPITALIZED_TOTAL) AS CAPITALIZED_TOTAL,
	Last(QUERY_014.Rate_Diff) AS Rate_Diff,
	Last(QUERY_014.DEFERRED_PRINCIPAL) AS DEFERRED_PRINCIPAL,
	Last(QUERY_014.MODIFICATION_REASON_CODE_LM) AS LAST_MOD_REASON_CODE_LM,
	Last(QUERY_014.MOD_RATE_EFFECTIVE_DATE) AS LastOfMOD_RATE_EFFECTIVE_DATE,
	Last(QUERY_014.DATE_OF_LAST_UPDATE) AS LastOfDATE_OF_LAST_UPDATE
FROM
	QUERY_014
GROUP BY
	QUERY_014.RFC_Loan_Nbr
)

*/
,QUERY_016 AS
(
SELECT
	RFC_Loan_Nbr,
	LOAN_STATUS,
	LOAN_NUMBER,
	BEFORE_MODIFICATION_CODE,
	MODIFICATION_CODE,
	MOD_EFFECTIVE_DATE,
	MOD_NUMBER,
	MOD_REVERSAL_REASON_CODE,
	BEGINNING_INVESTOR_NOTE_RATE,
	AFTER_LOAN_NOTE_RATE,
	BEFORE_SALE_SCHED_NOTE_RATE,
	CAPITALIZED_TOTAL,
	Rate_Diff,
	DEFERRED_PRINCIPAL,
	LAST_MOD_REASON_CODE_LM,
	LastOfMOD_RATE_EFFECTIVE_DATE,
	LastOfDATE_OF_LAST_UPDATE
FROM
    (
    SELECT
        QUERY_014.RFC_Loan_Nbr,
        QUERY_014.LOAN_STATUS AS LOAN_STATUS,
        QUERY_014.LOAN_NUMBER AS LOAN_NUMBER,
        QUERY_014.BEFORE_MODIFICATION_CODE AS BEFORE_MODIFICATION_CODE,
        QUERY_014.MODIFICATION_CODE AS MODIFICATION_CODE,
        QUERY_014.MOD_EFFECTIVE_DATE AS MOD_EFFECTIVE_DATE,
        QUERY_014.MOD_NUMBER AS MOD_NUMBER,
        QUERY_014.MOD_REVERSAL_REASON_CODE AS MOD_REVERSAL_REASON_CODE,
        QUERY_014.BEGINNING_INVESTOR_NOTE_RATE AS BEGINNING_INVESTOR_NOTE_RATE,
        QUERY_014.AFTER_LOAN_NOTE_RATE AS AFTER_LOAN_NOTE_RATE,
        QUERY_014.BEFORE_SALE_SCHED_NOTE_RATE AS BEFORE_SALE_SCHED_NOTE_RATE,
        QUERY_014.CAPITALIZED_TOTAL AS CAPITALIZED_TOTAL,
        QUERY_014.Rate_Diff AS Rate_Diff,
        QUERY_014.DEFERRED_PRINCIPAL AS DEFERRED_PRINCIPAL,
        QUERY_014.MODIFICATION_REASON_CODE_LM AS LAST_MOD_REASON_CODE_LM,
        QUERY_014.MOD_RATE_EFFECTIVE_DATE AS LastOfMOD_RATE_EFFECTIVE_DATE,
        QUERY_014.DATE_OF_LAST_UPDATE AS LastOfDATE_OF_LAST_UPDATE,
        ROW_NUMBER() OVER (PARTITION BY QUERY_014.RFC_Loan_Nbr ORDER BY DATE_OF_LAST_UPDATE DESC) AS FIRST_NUM
    FROM
        QUERY_014
    ) FST
WHERE
	FIRST_NUM = 1
)

/*
1dd_GetSBO_CapMods1 = QUERY_017
=======================================================
NOTE: 1dd_CurrentCapMod0
=======================================================
*/


,QUERY_017 AS
(
SELECT
	sbo_master.loanhist.CUTOFF_DATE,
	sbo_master.loanhist.INVESTOR_CUTOFF_DATE,
	sbo_master.loanhist.LOAN_NUMBER,
	sbo_master.loanhist.SBO_DATE,
	sbo_master.loanhist.SUB_TRAN_TYPE,
	sbo_master.loanhist.TRAN_TYPE,
	sbo_master.loanhist.EFFECTIVE_TRANSACTION_DATE,
	sbo_master.loanhist.GROSS_PRINCIPAL_applied gross_principal_received,
	sbo_master.loanhist.POSTING_DATE
FROM
	sbo_master.loanhist,
	VARIABLES
WHERE
	sbo_master.loanhist.INVESTOR_CUTOFF_DATE>VARIABLES.SBO_Inv_Cutoff_Date_Prior
	AND sbo_master.loanhist.TRAN_TYPE='L'
)
/*
1dd_GetSBO_CapMods2 = QUERY_018
=======================================================
NOTE: 1dd_CurrentCapMod
=======================================================
*/

,QUERY_018 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	QUERY_005.LOAN_STATUS,
	QUERY_017.CUTOFF_DATE,
	QUERY_017.INVESTOR_CUTOFF_DATE,
	QUERY_017.LOAN_NUMBER,
	QUERY_017.SBO_DATE,
	QUERY_017.SUB_TRAN_TYPE,
	QUERY_017.TRAN_TYPE,
	QUERY_017.EFFECTIVE_TRANSACTION_DATE,
	QUERY_017.GROSS_PRINCIPAL_RECEIVED,
	QUERY_017.POSTING_DATE,
	QUERY_006.MODIFICATION_REASON_CODE,
	QUERY_006.CUSTNAME,
	QUERY_006.SERVICER_LOAN_NUMBER
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
LEFT JOIN
	QUERY_017 ON QUERY_005.RFC_Loan_Nbr = QUERY_017.LOAN_NUMBER
WHERE
	QUERY_005.LOAN_STATUS='1'
	AND QUERY_017.INVESTOR_CUTOFF_DATE>TO_DATE('06/09/2011','mm/dd/yyyy')
	AND QUERY_017.LOAN_NUMBER Is Not Null
)







/*
1ddd_GetSBO_DebtForgiveMods1 = QUERY_019
=======================================================
NOTE: 1ddd_SBO_debtforgive0
=======================================================
*/

,QUERY_019 AS
(
SELECT
	sbo_master.LOANHIST.LOAN_NUMBER,
	Sum(sbo_master.LOANHIST.ancillary_fee_collected) AS ancillary_fee_amount,
	Sum((CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('MDFP')
			THEN sbo_master.LOANHIST.ancillary_fee_collected
			ELSE 0
		END)) AS MDFP_Amt,
	Sum((CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('MDFI')
			THEN sbo_master.LOANHIST.ancillary_fee_collected
			ELSE 0
		END)) AS MDFI_Amt,
	Sum((CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('MDFF')
			THEN sbo_master.LOANHIST.ancillary_fee_collected
			ELSE 0
		END)) AS MDFF_Amt,
	Sum((CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('MDFF','MDFP','MDFI')
			THEN sbo_master.LOANHIST.ancillary_fee_collected
			ELSE 0
		END)) AS Total_DF_Amt,
	Sum((CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('HFDP')
			THEN sbo_master.LOANHIST.ancillary_fee_collected
			ELSE 0
		END)) AS HFDP_Amt
FROM
	sbo_master.LOANHIST,
	VARIABLES
WHERE
	sbo_master.LOANHIST.CUTOFF_DATE>VARIABLES.Begin_Cycle_Date
	AND sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('MDFF','MDFI','MDFP','HFDP')
GROUP BY
	sbo_master.LOANHIST.LOAN_NUMBER
)

/*
1ddd_GetSBO_DebtForgiveMods2 = QUERY_020
=======================================================
NOTE: 1ddd_SBO_debtforgive
=======================================================
*/

,QUERY_020 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	QUERY_019.LOAN_NUMBER,
	QUERY_005.LOAN_STATUS,
	QUERY_019.ANCILLARY_FEE_AMOUNT,
	QUERY_019.MDFP_Amt,
	QUERY_019.MDFI_Amt,
	QUERY_019.MDFF_Amt,
	QUERY_019.Total_DF_Amt,
	QUERY_019.HFDP_Amt,
	QUERY_006.MODIFICATION_REASON_CODE
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
LEFT JOIN
	QUERY_019 ON QUERY_005.RFC_Loan_Nbr = QUERY_019.LOAN_NUMBER
WHERE
	QUERY_019.LOAN_NUMBER Is Not Null
	AND QUERY_005.LOAN_STATUS='1'
)





/*
1dddd_GetSBO_HMP = QUERY_021
=======================================================
NOTE: 1dddd_SBO_HMP_Defer_All
=======================================================
*/


,QUERY_021 AS
(
SELECT
	QUERY_005.RFC_Loan_Nbr,
	QUERY_005.LOAN_STATUS,
	Sum(sbo_master.LOANHIST.ancillary_fee_collected) AS SumOfANCILLARYFEEAMOUNT,
	Sum(CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('HFDP')
			THEN sbo_master.LOANHIST.ancillary_fee_collected*-1
			ELSE 0
		END) AS HFDP_Amt,
	Sum(CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('HFDF')
			THEN sbo_master.LOANHIST.ancillary_fee_collected*-1
			ELSE 0
		END) AS HFDF_Amt,
	Sum(CASE
			WHEN sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('HFDP','HFDF')
			THEN sbo_master.LOANHIST.ancillary_fee_collected*-1
			ELSE 0
		END) AS Total_DF_Amt,
	QUERY_006.MODIFICATION_REASON_CODE
FROM
	QUERY_005
LEFT JOIN
	sbo_master.LOANHIST ON QUERY_005.RFC_Loan_Nbr = sbo_master.LOANHIST.LOAN_NUMBER
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
WHERE
	sbo_master.LOANHIST.ANCILLARY_FEE_CODE In ('HFDP','HFDF')
GROUP BY
	QUERY_005.RFC_Loan_Nbr,
	QUERY_005.LOAN_STATUS,
	QUERY_006.MODIFICATION_REASON_CODE
HAVING
	QUERY_005.LOAN_STATUS='1'
)

/*
1e_Calc_PPIS_Amount1 = QUERY_022
=======================================================
NOTE: 1e_PPIS_AMT
=======================================================
*/
,QUERY_022 AS
(
SELECT
	QUERY_005.LOAN_NUMBER,
	query_005.BGN_INVESTOR_BALANCE AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	ROUND(QUERY_005.INTEREST_REMITTED
		-(CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN query_005.BGN_INVESTOR_BALANCE*QUERY_010.LPMI_RATE/1200
			ELSE 0
		END),2) AS Sched_Net_Int,
	ROUND(CASE
			WHEN QUERY_020.RFC_Loan_Nbr Is Null AND ((QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)*(query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE )/12)>0
			THEN ((QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)*(query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE )/12)
			ELSE 0
		END ,2) AS PrePmt_Int_SF_Amt,
	0 AS PrePmt_Int_SF_Amt2,
	QUERY_005.LOAN_STATUS,
	QUERY_005.Determination_Day,
	query_005.BGN_INVESTOR_BALANCE
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_020 ON QUERY_005.RFC_Loan_Nbr = QUERY_020.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('1')
	AND query_005.BGN_INVESTOR_BALANCE<>0
	AND QUERY_005.REO_STATUS='N'
UNION SELECT QUERY_005.LOAN_NUMBER,
	query_005.BGN_INVESTOR_BALANCE AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	ROUND(QUERY_005.INTEREST_REMITTED
		-CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN query_005.BGN_INVESTOR_BALANCE*QUERY_010.LPMI_RATE/1200
			ELSE 0
		END ,2) AS Sched_Net_Int,
	CASE
		WHEN QUERY_020.RFC_Loan_Nbr Is Null
		THEN ROUND((query_005.BGN_INVESTOR_BALANCE*(query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE )/12)-QUERY_005.INTEREST_REMITTED
				,2)
		ELSE 0
	END AS PrePmt_Int_SF_Amt,
	0 AS PrePmt_Int_SF_Amt2,
	QUERY_005.LOAN_STATUS,
	QUERY_005.Determination_Day,
	query_005.BGN_INVESTOR_BALANCE
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_020 ON QUERY_005.RFC_Loan_Nbr = QUERY_020.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('2','D','G')
	AND query_005.BGN_INVESTOR_BALANCE<>0
	AND QUERY_005.REO_STATUS='N'
)
/*
1ee_Calc_PPIS_Amount2 = QUERY_023
=======================================================
NOTE: ADDED TO QUERY_22 using UNION QUERY ABOVE
=======================================================
*/

/*
SELECT
	QUERY_005.LOAN_NUMBER,
	QUERY_005.BEGINNING_INVESTOR_BALANCE AS Sched_Beg_Prin_Bal,
	QUERY_005.LOAN_SCHEDULED_PART_PRINCIPAL AS Sched_End_Prin_Bal,
	ROUND(QUERY_005.INTEREST_REMITTED
		-CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN QUERY_005.BEGINNING_INVESTOR_BALANCE*QUERY_010.LPMI_RATE/1200
			ELSE 0
		END ,2) AS Sched_Net_Int,
	CASE
		WHEN QUERY_020.RFC_Loan_Nbr Is Null
		THEN ROUND((QUERY_005.BEGINNING_INVESTOR_BALANCE*(QUERY_005.BEGINNING_INVESTOR_NOTE_RATE-QUERY_005.BEGINNING_INVESTOR_SERV_FEE)/12)-QUERY_005.INTEREST_REMITTED
				,2)
		ELSE 0
	END AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_020 ON QUERY_005.RFC_Loan_Nbr = QUERY_020.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('2','D','G')
	AND QUERY_005.BEGINNING_INVESTOR_BALANCE<>0
	AND QUERY_005.REO_STATUS='N'
*/







/*
1f_get_Interest_Adjustments = QUERY_024
=======================================================
NOTE: 1f_Interest_Adjustments
=======================================================
*/

,QUERY_024 AS
(
SELECT
	QUERY_005.LOAN_NUMBER,
	CASE
		WHEN Wells_Interest_Adjustments.Loan_Number Is Null
		THEN 0
		ELSE Wells_Interest_Adjustments.Int_Adj_Amt
	END AS Int_Adj_Amt,
	Wells_Interest_Adjustments.Reason_Description
FROM
	QUERY_005
LEFT JOIN
	Wells_Interest_Adjustments ON QUERY_005.LOAN_NUMBER = Wells_Interest_Adjustments.Loan_Number
)





/*
=======================================================
MACRO: 2_Get_DMS_Data
=======================================================
NOTE: Details below FROM
	macro: 2_Get_DMS_Data
=======================================================
*/

/*
3a_DMS_Get_DM_Folders = QUERY_025
=======================================================
NOTE: 1_DMS_Folder
=======================================================
*/

,QUERY_25 AS
(
SELECT
	QUERY_006.LOAN_NUMBER,
	DMS.DFLT_MGMT_FOLDER.ASSET_SEQ_ID,
	DMS.DFLT_MGMT_FOLDER.DFLT_MGMT_FOLDER_SEQ_ID,
	DMS.DFLT_MGMT_FOLDER.START_DATE,
	DMS.DFLT_MGMT_FOLDER.END_DATE,
	DMS.DFLT_MGMT_FOLDER.RSN_FOR_DFLT_CODE,
	DMS.DFLT_MGMT_FOLDER.DELETE_IND
FROM
	QUERY_006
LEFT JOIN
	DMS.DFLT_MGMT_FOLDER@"""+oprodbridge+""".WORLD ON QUERY_006.LOAN_NUMBER = DMS.DFLT_MGMT_FOLDER.ASSET_SEQ_ID
WHERE
	DMS.DFLT_MGMT_FOLDER.DELETE_IND='N'
)

/*





/*
3b_DMS_Get_DMS_Segments = QUERY_026
=======================================================
NOTE: 2_DMS_Segment
=======================================================
*/
,Query_026 AS
(
SELECT
	QUERY_25.LOAN_NUMBER,
	QUERY_25.ASSET_SEQ_ID,
	QUERY_25.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_25.START_DATE AS QUERY_25_START_DATE,
	QUERY_25.END_DATE AS QUERY_25_END_DATE,
	QUERY_25.RSN_FOR_DFLT_CODE,
	QUERY_25.DELETE_IND AS QUERY_25_DELETE_IND,
	DMS.DFLT_MGMT_SEGMENT.DFLT_MGMT_SEGMENT_SEQ_ID,
	DMS.DFLT_MGMT_SEGMENT.DFLT_MGMT_SEGMENT_TYPE_CODE,
	DMS.DFLT_MGMT_SEGMENT_TYPE.DSCR,
	DMS.DFLT_MGMT_SEGMENT.DELETE_IND AS DMS_DEL_IND,
	DMS.DFLT_MGMT_SEGMENT.RESOLUTION_EST_DATE,
	DMS.DFLT_MGMT_SEGMENT.RESOLUTION_DATE,
	DMS.DFLT_MGMT_SEGMENT.RESOLUTION_TYPE_CODE,
	DMS.DFLT_MGMT_SEGMENT.START_DATE AS DMS_START_DATE,
	DMS.DFLT_MGMT_SEGMENT.END_DATE AS DMS_END_DATE,
	DMS.DFLT_MGMT_SEGMENT.EFF_DATE
FROM
	QUERY_25
LEFT JOIN
	DMS.DFLT_MGMT_SEGMENT@"""+oprodbridge+""".WORLD ON QUERY_25.DFLT_MGMT_FOLDER_SEQ_ID = DMS.DFLT_MGMT_SEGMENT.DFLT_MGMT_FOLDER_SEQ_ID
LEFT JOIN
	DMS.DFLT_MGMT_SEGMENT_TYPE@"""+oprodbridge+""".WORLD ON DMS.DFLT_MGMT_SEGMENT.DFLT_MGMT_SEGMENT_TYPE_CODE = DMS.DFLT_MGMT_SEGMENT_TYPE.DFLT_MGMT_SEGMENT_TYPE_CODE
								AND QUERY_25.LOAN_NUMBER = DMS.DFLT_MGMT_SEGMENT.ASSET_SEQ_ID
WHERE
	DMS.DFLT_MGMT_SEGMENT.DELETE_IND='N'
)
/*
3c_DMS_Get_BK1 = QUERY_027
=======================================================
NOTE: 4_DMS_BK0
=======================================================
*/
,QUERY_027 AS
(
SELECT
	Query_026.LOAN_NUMBER,
	Query_026.ASSET_SEQ_ID,
	Query_026.DFLT_MGMT_FOLDER_SEQ_ID,
	Query_026.QUERY_25_START_DATE,
	Query_026.QUERY_25_END_DATE,
	Query_026.RSN_FOR_DFLT_CODE,
	Query_026.QUERY_25_DELETE_IND,
	Query_026.DFLT_MGMT_SEGMENT_SEQ_ID,
	Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE,
	Query_026.DSCR,
	Query_026.DMS_DEL_IND,
	Query_026.RESOLUTION_EST_DATE,
	Query_026.RESOLUTION_DATE,
	Query_026.RESOLUTION_TYPE_CODE,
	Query_026.DMS_START_DATE,
	Query_026.DMS_END_DATE,
	Query_026.EFF_DATE
FROM
	Query_026
WHERE
	Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE='03'
	AND Query_026.RESOLUTION_DATE Is Null
UNION SELECT Query_026.LOAN_NUMBER,
	Query_026.ASSET_SEQ_ID,
	Query_026.DFLT_MGMT_FOLDER_SEQ_ID,
	Query_026.QUERY_25_START_DATE,
	Query_026.QUERY_25_END_DATE,
	Query_026.RSN_FOR_DFLT_CODE,
	Query_026.QUERY_25_DELETE_IND,
	Query_026.DFLT_MGMT_SEGMENT_SEQ_ID,
	Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE,
	Query_026.DSCR,
	Query_026.DMS_DEL_IND,
	Query_026.RESOLUTION_EST_DATE,
	Query_026.RESOLUTION_DATE,
	Query_026.RESOLUTION_TYPE_CODE,
	Query_026.DMS_START_DATE,
	Query_026.DMS_END_DATE,
	Query_026.EFF_DATE
FROM
	Query_026,
	VARIABLES
WHERE
	Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE='03'
	AND Query_026.RESOLUTION_DATE>VARIABLES.Begin_Cycle_Date
)
/*
3c_DMS_Get_BK2 = QUERY_028
=======================================================
NOTE: ADDED AS UNION SELECT QUERY ABOVE
=======================================================
*/
/*ORIG QUERY:
INSERT
INTO
	QUERY_027 ( LOAN_NUMBER,
	ASSET_SEQ_ID,
	DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_25_START_DATE,
	QUERY_25_END_DATE,
	RSN_FOR_DFLT_CODE,
	QUERY_25_DELETE_IND,
	DFLT_MGMT_SEGMENT_SEQ_ID,
	DFLT_MGMT_SEGMENT_TYPE_CODE,
	DSCR,
	DMS_DEL_IND,
	RESOLUTION_EST_DATE,
	RESOLUTION_DATE,
	RESOLUTION_TYPE_CODE,
	DMS_START_DATE,
	DMS_END_DATE,
	EFF_DATE )
SELECT
	Query_026.LOAN_NUMBER,
	Query_026.ASSET_SEQ_ID,
	Query_026.DFLT_MGMT_FOLDER_SEQ_ID,
	Query_026.QUERY_25_START_DATE,
	Query_026.QUERY_25_END_DATE,
	Query_026.RSN_FOR_DFLT_CODE,
	Query_026.QUERY_25_DELETE_IND,
	Query_026.DFLT_MGMT_SEGMENT_SEQ_ID,
	Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE,
	Query_026.DSCR,
	Query_026.DMS_DEL_IND,
	Query_026.RESOLUTION_EST_DATE,
	Query_026.RESOLUTION_DATE,
	Query_026.RESOLUTION_TYPE_CODE,
	Query_026.DMS_START_DATE,
	Query_026.DMS_END_DATE,
	Query_026.EFF_DATE
FROM
	Query_026,
	VARIABLES
WHERE
	(((Query_026.DFLT_MGMT_SEGMENT_TYPE_CODE)='03') AND ((Query_026.RESOLUTION_DATE)>VARIABLES.Begin_Cycle_Date));
*/


/*
3cc_DMS_Get_BK3 = QUERY_029
=======================================================
NOTE: 4_DMS_BK00
=======================================================
*/
,QUERY_029 AS
(
SELECT
	DMS.BKRCY_CASE.BKRCY_CASE_SEQ_ID,
	DMS.BKRCY_CASE.PETITION_FILED_DATE,
	DMS.BKRCY_CASE.BKRCY_CHAPTER_CODE,
	DMS.BKRCY_CASE.CASE_ID
FROM
	DMS.BKRCY_CASE@"""+oprodbridge+""".WORLD,
	VARIABLES
WHERE
	DMS.BKRCY_CASE.PETITION_FILED_DATE<VARIABLES.Current_Date
)

/*
3ccc_DMS_Get_BK4 = QUERY_030
=======================================================
NOTE: 4_DMS_BK000
=======================================================
*/
,QUERY_030 AS
(
SELECT
	QUERY_027.LOAN_NUMBER,
	QUERY_027.ASSET_SEQ_ID,
	QUERY_027.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_027.QUERY_25_START_DATE,
	QUERY_027.QUERY_25_END_DATE,
	QUERY_027.RSN_FOR_DFLT_CODE,
	QUERY_027.QUERY_25_DELETE_IND,
	QUERY_027.DFLT_MGMT_SEGMENT_SEQ_ID,
	QUERY_027.DFLT_MGMT_SEGMENT_TYPE_CODE,
	QUERY_027.DSCR AS QUERY_027_DSCR,
	QUERY_027.DMS_DEL_IND,
	QUERY_027.RESOLUTION_EST_DATE,
	QUERY_027.RESOLUTION_DATE,
	QUERY_027.RESOLUTION_TYPE_CODE,
	QUERY_027.DMS_START_DATE,
	QUERY_027.DMS_END_DATE,
	QUERY_027.EFF_DATE,
	QUERY_029.PETITION_FILED_DATE,
	QUERY_029.BKRCY_CHAPTER_CODE,
	DMS.BKRCY_CHAPTER.DSCR AS DMS_BKRCY_CHAPTER_DSCR,
	QUERY_029.CASE_ID,
	DMS.BKRCY.POST_PETITION_DUE_DATE
FROM
	QUERY_027
LEFT JOIN
	DMS.BKRCY@"""+oprodbridge+""".WORLD ON QUERY_027.LOAN_NUMBER = DMS.BKRCY.ASSET_SEQ_ID
							AND QUERY_027.DFLT_MGMT_SEGMENT_SEQ_ID = DMS.BKRCY.DFLT_MGMT_SEGMENT_SEQ_ID
LEFT JOIN
	QUERY_029 ON DMS.BKRCY.BKRCY_CASE_SEQ_ID = QUERY_029.BKRCY_CASE_SEQ_ID
LEFT JOIN
	DMS.BKRCY_CHAPTER@"""+oprodbridge+""".WORLD ON QUERY_029.BKRCY_CHAPTER_CODE = DMS.BKRCY_CHAPTER.BKRCY_CHAPTER_CODE
									
WHERE
	QUERY_027.DFLT_MGMT_SEGMENT_TYPE_CODE='03'
ORDER BY
	QUERY_027.LOAN_NUMBER,
	QUERY_029.PETITION_FILED_DATE
)
/*
3ccc_DMS_Get_BK5 = QUERY_031
=======================================================
NOTE: 4_DMS_BK
=======================================================
*/

,QUERY_031 AS
(
SELECT
	*
FROM
	(
	SELECT
		QUERY_030.LOAN_NUMBER,
		QUERY_030.ASSET_SEQ_ID,
		QUERY_030.DFLT_MGMT_FOLDER_SEQ_ID,
		QUERY_030.QUERY_25_START_DATE,
		QUERY_030.QUERY_25_END_DATE,
		QUERY_030.RSN_FOR_DFLT_CODE,
		QUERY_030.QUERY_25_DELETE_IND,
		QUERY_030.DFLT_MGMT_SEGMENT_SEQ_ID,
		QUERY_030.DFLT_MGMT_SEGMENT_TYPE_CODE,
		QUERY_030.QUERY_027_DSCR AS DMS_Segment_DSCR,
		QUERY_030.DMS_DEL_IND,
		QUERY_030.RESOLUTION_EST_DATE,
		QUERY_030.RESOLUTION_DATE,
		QUERY_030.RESOLUTION_TYPE_CODE,
		QUERY_030.DMS_START_DATE,
		QUERY_030.DMS_END_DATE,
		QUERY_030.EFF_DATE,
		QUERY_030.PETITION_FILED_DATE,
		QUERY_030.BKRCY_CHAPTER_CODE,
		QUERY_030.DMS_BKRCY_CHAPTER_DSCR,
		QUERY_030.CASE_ID,
		QUERY_030.POST_PETITION_DUE_DATE,
		ROW_NUMBER() OVER (PARTITION BY QUERY_030.LOAN_NUMBER ORDER BY 1) AS FIRST_NUM
	FROM
		QUERY_030
	) FST
WHERE
	FIRST_NUM = 1
)
/*
3d_DMS_get_FCL1 = QUERY_032
=======================================================
NOTE: 5_DMS_FCL0
=======================================================
*/

,QUERY_032 AS
(
SELECT
	QUERY_026.LOAN_NUMBER,
	QUERY_026.ASSET_SEQ_ID,
	QUERY_026.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_026.QUERY_25_START_DATE,
	QUERY_026.QUERY_25_END_DATE,
	QUERY_026.RSN_FOR_DFLT_CODE,
	QUERY_026.QUERY_25_DELETE_IND,
	QUERY_026.DFLT_MGMT_SEGMENT_SEQ_ID,
	QUERY_026.DFLT_MGMT_SEGMENT_TYPE_CODE,
	QUERY_026.DSCR,
	QUERY_026.DMS_DEL_IND,
	QUERY_026.RESOLUTION_EST_DATE,
	QUERY_026.RESOLUTION_DATE,
	QUERY_026.RESOLUTION_TYPE_CODE,
	QUERY_026.DMS_START_DATE,
	QUERY_026.DMS_END_DATE,
	QUERY_026.EFF_DATE
FROM
	QUERY_026
WHERE
	QUERY_026.DFLT_MGMT_SEGMENT_TYPE_CODE In ('04')
	AND QUERY_026.RESOLUTION_DATE Is Null
UNION SELECT QUERY_026.LOAN_NUMBER,
	QUERY_026.ASSET_SEQ_ID,
	QUERY_026.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_026.QUERY_25_START_DATE,
	QUERY_026.QUERY_25_END_DATE,
	QUERY_026.RSN_FOR_DFLT_CODE,
	QUERY_026.QUERY_25_DELETE_IND,
	QUERY_026.DFLT_MGMT_SEGMENT_SEQ_ID,
	QUERY_026.DFLT_MGMT_SEGMENT_TYPE_CODE,
	QUERY_026.DSCR,
	QUERY_026.DMS_DEL_IND,
	QUERY_026.RESOLUTION_EST_DATE,
	QUERY_026.RESOLUTION_DATE,
	QUERY_026.RESOLUTION_TYPE_CODE,
	QUERY_026.DMS_START_DATE,
	QUERY_026.DMS_END_DATE,
	QUERY_026.EFF_DATE
FROM
	QUERY_026,
	VARIABLES
WHERE
	QUERY_026.DFLT_MGMT_SEGMENT_TYPE_CODE In ('04')
	AND QUERY_026.RESOLUTION_DATE>VARIABLES.Begin_Cycle_Date
)
/*
3d_DMS_get_FCL2
=======================================================
NOTE: ADDED AS UNION QUERY TO QUERY_032 ABOVE
=======================================================
*/
/*
3dd_DMS_get_FCL3 = QUERY_033
=======================================================
NOTE: 5_DMS_FCL00
=======================================================
*/

,QUERY_033 AS
(
SELECT
	FC.ASSET_SEQ_ID,
	FC.DFLT_MGMT_FOLDER_SEQ_ID,
	FC.DFLT_MGMT_SEGMENT_SEQ_ID,
	FC.LEGAL_FIRST_DATE,
	FC.SALE_SCHED_DATE,
	FC.SALE_ACTUAL_DATE,
	FC.SALE_END_AMT,
	FC.FCLS_SALE_RESULT_CODE,
	FC.FCL_REFRL_DATE
FROM
	DMS.FCLS@"""+oprodbridge+""".WORLD FC,
	VARIABLES
WHERE
	FC.FCL_REFRL_DATE BETWEEN
							TO_DATE('01/01/2007','mm/dd/yyyy')
							And VARIABLES.Monthend_Cycle_Date
)
/*
3dd_DMS_get_FCL4 = QUERY_033
=======================================================
NOTE: 5_DMS_FCL
=======================================================
*/
,QUERY_034 AS
(
SELECT
	QUERY_032.LOAN_NUMBER,
	QUERY_032.ASSET_SEQ_ID,
	QUERY_032.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_032.QUERY_25_START_DATE,
	QUERY_032.QUERY_25_END_DATE,
	QUERY_032.RSN_FOR_DFLT_CODE,
	QUERY_032.QUERY_25_DELETE_IND,
	QUERY_032.DFLT_MGMT_SEGMENT_SEQ_ID,
	QUERY_032.DFLT_MGMT_SEGMENT_TYPE_CODE,
	QUERY_032.DSCR AS QUERY_034_DSCR,
	QUERY_032.DMS_DEL_IND,
	QUERY_032.RESOLUTION_EST_DATE,
	QUERY_032.RESOLUTION_DATE,
	QUERY_032.RESOLUTION_TYPE_CODE,
	QUERY_032.DMS_START_DATE,
	QUERY_032.DMS_END_DATE,
	QUERY_032.EFF_DATE,
	QUERY_033.LEGAL_FIRST_DATE,
	QUERY_033.SALE_SCHED_DATE,
	QUERY_033.SALE_ACTUAL_DATE,
	QUERY_033.SALE_END_AMT,
	DMS.FCLS_SALE_RESULT.DSCR AS DMS_DSCR,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_033.FCL_REFRL_DATE
FROM
	QUERY_032
LEFT JOIN
	QUERY_005 ON QUERY_032.LOAN_NUMBER = QUERY_005.RFC_Loan_Nbr
LEFT JOIN
	QUERY_033 ON QUERY_032.DFLT_MGMT_SEGMENT_SEQ_ID = QUERY_033.DFLT_MGMT_SEGMENT_SEQ_ID
LEFT JOIN
	DMS.FCLS_SALE_RESULT@"""+oprodbridge+""".WORLD ON QUERY_033.FCLS_SALE_RESULT_CODE = DMS.FCLS_SALE_RESULT.FCLS_SALE_RESULT_CODE
WHERE
	QUERY_033.ASSET_SEQ_ID IS NOT NULL
)

/*
3ddd_DMS_get_FCL5 = QUERY_035
=======================================================
NOTE: 5b_DMS_FCL2
=======================================================
*/
,QUERY_035 AS
(
SELECT
	QUERY_034.LOAN_NUMBER,
	QUERY_034.ASSET_SEQ_ID,
	QUERY_034.DFLT_MGMT_FOLDER_SEQ_ID,
	QUERY_034.QUERY_25_START_DATE,
	QUERY_034.QUERY_25_END_DATE,
	QUERY_034.RSN_FOR_DFLT_CODE,
	QUERY_034.QUERY_25_DELETE_IND,
	QUERY_034.DFLT_MGMT_SEGMENT_SEQ_ID,
	QUERY_034.DFLT_MGMT_SEGMENT_TYPE_CODE,
	QUERY_034.QUERY_034_DSCR,
	QUERY_034.DMS_DEL_IND,
	QUERY_034.RESOLUTION_EST_DATE,
	QUERY_034.RESOLUTION_DATE,
	QUERY_034.RESOLUTION_TYPE_CODE,
	QUERY_034.DMS_START_DATE,
	QUERY_034.DMS_END_DATE,
	QUERY_034.EFF_DATE,
	QUERY_034.LEGAL_FIRST_DATE,
	QUERY_034.SALE_SCHED_DATE,
	QUERY_034.SALE_ACTUAL_DATE,
	QUERY_034.SALE_END_AMT,
	QUERY_034.DMS_DSCR,
	QUERY_034.LOAN_STATUS,
	QUERY_034.LOAN_STATUS_DATE,
	QUERY_034.FCL_REFRL_DATE
FROM
	QUERY_034
ORDER BY
	QUERY_034.LOAN_NUMBER,
	QUERY_034.DMS_START_DATE
)

/*
3dddd_DMS_get_FCL6 = QUERY_036
=======================================================
NOTE: 5c_DMS_FCL3
=======================================================
*/
,QUERY_036 AS
(
SELECT
    *
FROM
    (
    SELECT
        QUERY_035.LOAN_NUMBER,
        QUERY_035.ASSET_SEQ_ID,
        QUERY_035.DFLT_MGMT_FOLDER_SEQ_ID AS LST_DM_FLDR_SEQ_ID,
        QUERY_035.QUERY_25_START_DATE AS LST_DM_FLDR_START_DT,
        QUERY_035.QUERY_25_END_DATE AS LST_DM_FLDR_END_DT,
        QUERY_035.RSN_FOR_DFLT_CODE AS LST_RSN_DFLT_CODE,
        QUERY_035.QUERY_25_DELETE_IND AS LST_DMS_FLDR_DEL_IND,
        QUERY_035.DFLT_MGMT_SEGMENT_SEQ_ID AS LST_DMS_MGMT_SEG_SEQ_ID,
        QUERY_035.DFLT_MGMT_SEGMENT_TYPE_CODE AS LST_DMS_MGMT_SEG_TYPE_CODE,
        QUERY_035.QUERY_034_DSCR AS LST_34_DSCR,
        QUERY_035.DMS_DEL_IND AS LST_DMS_DEL_IND,
        QUERY_035.RESOLUTION_EST_DATE AS LST_RES_EST_DATE,
        QUERY_035.RESOLUTION_DATE AS LST_RES_DATE,
        QUERY_035.RESOLUTION_TYPE_CODE AS LST_RES_TYPE_CODE,
        QUERY_035.DMS_START_DATE AS LST_DMS_START_DATE,
        QUERY_035.DMS_END_DATE AS LST_DMS_END_DATE,
        QUERY_035.EFF_DATE AS LST_EFF_DATE,
        QUERY_035.LEGAL_FIRST_DATE AS LST_LEGAL_FIRST_DATE,
        QUERY_035.SALE_SCHED_DATE AS LST_SALE_SCHED_DATE,
        QUERY_035.SALE_ACTUAL_DATE AS LST_SALE_ACTUAL_DATE,
        QUERY_035.SALE_END_AMT AS LST_SALE_END_AMT,
        QUERY_035.DMS_DSCR AS LST_DMS_DSCR,
        QUERY_035.LOAN_STATUS AS LST_LOAN_STATUS,
        QUERY_035.LOAN_STATUS_DATE AS LST_LOAN_STATUS_DATE,
        QUERY_035.FCL_REFRL_DATE AS LST_FCL_REFRL_DATE,
        ROW_NUMBER() OVER (PARTITION BY QUERY_035.LOAN_NUMBER ORDER BY QUERY_035.RESOLUTION_DATE DESC) AS FIRSTNUM
    FROM
        QUERY_035
    ) FST
WHERE
    FIRSTNUM = 1
)
/*
=======================================================
MACRO: 3_Refresh_Interest_Adjustments
=======================================================
NOTE: The queries that follow are FROM
	the macro: 3_Refresh_Interest_Adjustments
=======================================================
*/




/*
1f_get_Interest_Adjustments = QUERY_032
=======================================================
NOTE: 1f_Interest_Adjustments

This is the same as above... no need to run twice.
=======================================================
*/

/*
SELECT
	QUERY_005.LOAN_NUMBER,
	IIf(Wells_Interest_Adjustments.Loan_Number Is Null,0,Wells_Interest_Adjustments.Int_Adj_Amt) AS Int_Adj_Amt,
	Wells_Interest_Adjustments.Reason_Description
INTO
	QUERY_024
FROM
	QUERY_005
LEFT JOIN
	Wells_Interest_Adjustments ON QUERY_005.LOAN_NUMBER = Wells_Interest_Adjustments.Loan_Number;
*/




/*
=======================================================
MACRO: 4_Make_Reports
=======================================================
NOTE: The queries that follow are FROM
	the macro: 4_Make_Reports
=======================================================
*/


/*
4a_Payoff_Data = QUERY_037
=======================================================
NOTE: 9_WellsReport
=======================================================
*/

,QUERY_037a AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	QUERY_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	QUERY_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	(QUERY_005.BGN_SCHED_INV_NOTE_RATE -QUERY_005.BGN_SCHED_INV_SVC_FEE_RATE )*100 AS Net_Int_Rate,
	QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100 AS SubServicer_Fee_Rate,
	(QUERY_005.BGN_SCHED_INV_SVC_FEE_RATE *100)-(QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100) AS Servicer_Fee_Rate,
	Round(QUERY_005.BGN_INVESTOR_BALANCE *QUERY_005.BGN_SCHED_INV_SVC_FEE_RATE /12,2) AS Serv_Fee_Amt,
	2.22-2.22 AS New_Loan_Rate,
	2.22-2.22 AS New_Pay_Amt,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Actl_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.DEFRD_PART_PRINCIPAL AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.DEFRD_PART_PRINCIPAL AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Curt_Adj_Amt_1,
	QUERY_005.PRINCIPAL_ADJUSTMENTS AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Curt_Adj_Amt_2,
	Null AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Curt_Adj_Amt_3,
	QUERY_005.PRINCIPAL_REMITTED AS PIF_Amt,
	QUERY_005.LOAN_STATUS_DATE AS PIF_Date,
	'60' AS Action_Code,
	Null AS Breach_Flag,
	QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	0 AS Soldier_Sailors_Adj_Amt,
	2.22-2.22 AS Mod_SF_Amt,
	Null AS Non_Adv_Loan_Amt,
	2.22-2.22 AS Loan_Loss_Amt,
	2.22-2.22 AS Int_Loss_Amt,
	QUERY_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	QUERY_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	QUERY_005.END_SCHED_PART_PRINCIPAL +query_005.DEFRD_PART_PRINCIPAL AS SCHD_END_PBAL_TOT_DEBT_OWD,
	2.22-2.22 AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	QUERY_005.INTEREST_REMITTED AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actl_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS Prepay_Penalty_Waived,
	Null AS Waived_PPP_Reason,
	QUERY_006.REO_STATUS_DATE AS Mod_Date,
	'' AS Mod_Type,
	2.22-2.22 AS Delinq_PandI_Advance_Amt,
	2.22-2.22 AS Sub_Recovery_Amt,
	CASE
		WHEN tbl_AAR_Pools.COMP_INT_TYPE_CODE Like '1'
		THEN 0
		ELSE QUERY_022.PrePmt_Int_SF_Amt
	END AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	QUERY_022 ON QUERY_005.LOAN_NUMBER = QUERY_022.LOAN_NUMBER
LEFT JOIN
	tbl_AAR_Pools ON QUERY_005.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.LOAN_NUMBER = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
LEFT JOIN
	QUERY_006 ON QUERY_005.LOAN_NUMBER = QUERY_006.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('2','D','G')
)
/*
4c_Repurchase_Data = QUERY_038
=======================================================
NOTE:
	ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/

,QUERY_038 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	QUERY_005.LOAN_NUMBER AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT   AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE  *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE  -query_005.BGN_SCHED_INV_SVC_FEE_RATE )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE  -query_005.BGN_SCHED_INV_SVC_FEE_RATE )*100
	END	AS Net_Int_Rate,
	query_005.BGN_SCHED_INV_SVC_FEE_RATE *100 AS Service_Fee_Rate,
	0 AS SubServicer_Fee_Rate,
	Round(query_005.BGN_INVESTOR_BALANCE *query_005.BGN_SCHED_INV_SVC_FEE_RATE /12,2) AS Serv_Fee_Amt,
	0 AS New_Loan_Rate,
	0 AS New_Pay_Amt,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL + query_005.DEFRD_PART_PRINCIPAL AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.DEFRD_PART_PRINCIPAL AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	QUERY_005.PRINCIPAL_ADJUSTMENTS AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	Null AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	QUERY_005.PRINCIPAL_REMITTED AS PIF_Amt,
	QUERY_005.ACCT_CYCLE_MONTHEND_DATE AS PIF_Date,
	'65' AS Action_Code,
	Null AS Beach_Flag,
	QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	Null AS SSA_Adj,
	0 AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	2.22-2.22 AS Loan_Loss_Amt,
	2.22-2.22 AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	2.22-2.22 AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	QUERY_005.INTEREST_REMITTED AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	Null AS Mod_Date,
	Null AS Mod_Type,
	2.22-2.22 AS Delinq_PI_Advance_Amt,
	2.22-2.22 AS Sub_Recovery_Amt,
	0 AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('A','B','M','O','H')
)
/*
4d_Get_Liq_Data = QUERY_039
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/

,QUERY_039 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	QUERY_002.END_SCHED_PMT_AMT AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100 AS SubServicer_Fee_Rate,
	(query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100)-(QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100) AS Service_Fee_Rate,
	Round(
		CASE
			WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
			THEN (query_005.BGN_INVESTOR_BALANCE  *query_005.BGN_SCHED_INV_SVC_FEE_RATE  /12)
			ELSE 0
		END ,2) AS Serv_Fee_Amt,
	0 AS New_Loan_Rate,
	0 AS New_Pay_Amt,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.DEFRD_PART_PRINCIPAL  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.DEFRD_PART_PRINCIPAL  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	0 AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	0 AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	0 AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	QUERY_005.ACCT_CYCLE_MONTHEND_DATE AS PIF_Date,
	'60' AS Action_Code,
	Null AS Beach_Flag,
	0 AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	0 AS SSA_Adj,
	0 AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	CASE
		WHEN QUERY_005.PRINCIPAL_REMITTED<0
		THEN (sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER.rptd_loss_amount*-1)-QUERY_005.PRINCIPAL_REMITTED
		ELSE sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER.rptd_loss_amount*-1
	END AS Loan_Loss_Amt,
	CASE
		WHEN QUERY_005.PRINCIPAL_REMITTED<0
		THEN QUERY_005.PRINCIPAL_REMITTED
		ELSE 0
	END AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE   AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.DEFRD_PART_PRINCIPAL  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	query_005.BGN_INVESTOR_BALANCE   AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	CASE
		WHEN sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER.rptd_loss_amount>0
		THEN QUERY_005.INTEREST_REMITTED
		ELSE 0
	END AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	Null AS Mod_Date,
	Null AS Mod_Type,
	0 AS Delinq_PI_Advance_Amt,
	0 AS Sub_Recovery_Amt,
	0 AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER ON query_005.last_investor_cutoff_date = sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER.last_investor_cutoff_date
										AND QUERY_005.RFC_Loan_Nbr = sbo_MASTER.REO_LOSS_CERTIFICATION_HEADER.LOAN_NUMBER
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
LEFT JOIN
	QUERY_009 ON QUERY_006.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.LOAN_NUMBER = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('3','4','5','6')
	AND QUERY_005.LOAN_STATUS_DATE=query_005.last_investor_cutoff_date
	AND query_005.BGN_INVESTOR_BALANCE  <>0
)

/*
4e_Get_Liq_Revision_Data = QUERY_040
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/

,QUERY_040 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100 AS Service_Fee_Rate,
	0 AS SubServicer_Fee_Rate,
	Round(
		CASE
			WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
			THEN (query_005.BGN_INVESTOR_BALANCE *query_005.BGN_SCHED_INV_SVC_FEE_RATE  /12)
			ELSE 0
		END ,2) AS Serv_Fee_Amt,
	0 AS New_Loan_Rate,
	0 AS New_Pay_Amt,
	Null AS ARM_Index_Rate,
	0 AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.defrd_part_principal  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.defrd_part_principal  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	0 AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	0 AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	Null AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	QUERY_005.ACCT_CYCLE_MONTHEND_DATE AS PIF_Date,
	'60' AS Action_Code,
	Null AS Beach_Flag,
	0 AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	0 AS SSA_Adj,
	0 AS Mod_SF_Adj,
	0 AS Non_Adv_Ln_Amt,
	0 AS Loan_Loss_Amt,
	CASE
		WHEN QUERY_005.ANCILLARY_FEES_REMITTED_INV<0
		THEN QUERY_005.ANCILLARY_FEES_REMITTED_INV
		ELSE 0
	END AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.defrd_part_principal  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	0 AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	0 AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	0 AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	Null AS Mod_Date,
	Null AS Mod_Type,
	0 AS Delinq_PI_Advance_Amt,
	CASE
		WHEN QUERY_005.ANCILLARY_FEES_REMITTED_INV>0
		THEN QUERY_005.ANCILLARY_FEES_REMITTED_INV
		ELSE 0
	END AS Sub_Recovery_Amt,
	0 AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.RFC_Loan_Nbr
LEFT JOIN
	QUERY_009 ON QUERY_006.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('3','4','5','6')
	AND QUERY_005.LOAN_STATUS_DATE<>query_005.last_investor_cutoff_date
)





/*
4f_Get_Liq_Reversal_Data = QUERY_041
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/

,QUERY_041 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	QUERY_005.INVESTOR_LOAN_NUMBER*1 AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE	
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100 AS Service_Fee_Rate,
	0 AS SubServicer_Fee_Rate,
	0 AS Serv_Fee_Amt,
	0 AS New_Pay_Amt,
	CASE
		WHEN query_005.END_SCHED_NOTE_RATE <>query_005.BGN_SCHED_INV_NOTE_RATE 
		THEN query_005.END_SCHED_NOTE_RATE *100
		ELSE 0
	END AS New_Loan_Rate,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	CASE
		WHEN QUERY_002.LOAN_NUMBER Is Null
		THEN 0
		ELSE QUERY_002.LOAN_PARTICIPANT_PRINCIPAL
	END AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.defrd_part_principal  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.defrd_part_principal  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	0 AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	0 AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	0 AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	Null AS PIF_Date,
	Null AS Action_Code,
	Null AS Beach_Flag,
	0 AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	Null AS SSA_Adj,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE)-(query_005.BGN_SCHED_INV_NOTE_RATE /100))*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END ,2) AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	0 AS Loan_Loss_Amt,
	0 AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.defrd_part_principal  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	QUERY_005.PRINCIPAL_REMITTED AS Sched_Prin_Amt,
	0 AS Deferred_Int_Amt,
	Round(QUERY_005.INTEREST_REMITTED-(CASE
											WHEN QUERY_010.LOAN_NUMBER Is Not Null
											THEN query_005.BGN_INVESTOR_BALANCE *QUERY_010.LPMI_RATE/1200
											ELSE 0
										END)
		,2) AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	0 AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN QUERY_016.MOD_EFFECTIVE_DATE
		ELSE Null
	END AS Mod_Date,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN 'Loss Mitigation'
		ELSE Null
	END AS Mod_Type,
	0 AS Delinq_PI_Advance_Amt,
	0 AS Sub_Recovery_Amt,
	0 AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_012 ON QUERY_005.RFC_Loan_Nbr = QUERY_012.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
WHERE
	QUERY_005.LOAN_STATUS In ('1')
	AND query_005.BGN_INVESTOR_BALANCE <>0
	AND QUERY_012.LOAN_NUMBER Is Not Null
)




/*
4g_Get_Active_NonREO = QUERY_042
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/
,QUERY_042 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100 AS SubServicer_Fee_Rate,
	(query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100)-(QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100) AS Service_Fee_Rate,
	CASE
		WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
		THEN query_005.SCHED_SVC_FEE_AMOUNT  
		ELSE 0
	END AS Serv_Fee_Amt,
	Round(
		CASE 
			WHEN query_005.END_SCHED_NOTE_RATE <>query_005.BGN_SCHED_INV_NOTE_RATE 
			THEN query_005.END_SCHED_NOTE_RATE *100
			ELSE 0
		END ,3) AS New_Loan_Rate,
	0 AS New_Pay_Amt,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.defrd_part_principal  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.defrd_part_principal  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	CASE
		WHEN QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED Is Null
		THEN 0
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN 0
		WHEN (QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)=0
		THEN 0
		ELSE QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED
	END AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	CASE
		WHEN QUERY_005.PRINCIPAL_ADJUSTMENTS Is Null
		THEN 0
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN 0
		WHEN (QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)=0
		THEN 0
		ELSE QUERY_005.PRINCIPAL_ADJUSTMENTS
	END AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	0 AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	Null AS PIF_Date,
	CASE
		WHEN QUERY_031.LOAN_NUMBER Is Not Null
		THEN '15'
		WHEN QUERY_036.LOAN_NUMBER Is Not Null
		THEN '30'
		ELSE Null
	END AS Action_Code,
	Null AS Beach_Flag,
	CASE
		WHEN QUERY_020.RFC_Loan_Nbr Is Not Null
		THEN QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV+QUERY_020.ANCILLARY_FEE_AMOUNT-QUERY_024.Int_Adj_Amt
		ELSE QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV-QUERY_024.Int_Adj_Amt
	END AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null AND QUERY_016.MODIFICATION_CODE Like '4'
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE-query_005.BGN_SCHED_INV_SVC_FEE_RATE  )
				-((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )))*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END ,2) AS SSA_Adj,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null AND QUERY_016.MODIFICATION_CODE Not Like '4'
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE-query_005.BGN_SCHED_INV_SVC_FEE_RATE  )
				-((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )))*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END ,2) AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	0 AS Loan_Loss_Amt,
	0 AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.defrd_part_principal  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	CASE
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN QUERY_005.PRINCIPAL_ADJUSTMENTS+QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+query_005.SCHED_PRINCIPAL_AMOUNT -QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
		ELSE query_005.SCHED_PRINCIPAL_AMOUNT -QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
	END	AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	Round(QUERY_005.INTEREST_REMITTED-QUERY_022.PrePmt_Int_SF_Amt
		-CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN query_005.BGN_INVESTOR_BALANCE *QUERY_010.LPMI_RATE/1200
			ELSE 0
		END,2) AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN QUERY_016.MOD_EFFECTIVE_DATE
		ELSE Null
	END AS Mod_Date,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN
			CASE
				WHEN QUERY_016.MODIFICATION_CODE Like '4'
				THEN 'SCRA'
				ELSE 'Loss Mitigation'
			END
		ELSE Null
	END AS Mod_Type,
	CASE
		WHEN QUERY_013.LOAN_NUMBER Is Not Null
		THEN QUERY_013.Delinq_PI_Advance_Amt
		ELSE 0
	END AS Delinq_PI_Advance_Amt,
	0 AS Sub_Recovery_Amt,
	QUERY_022.PrePmt_Int_SF_Amt AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_012 ON QUERY_005.RFC_Loan_Nbr = QUERY_012.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_020 ON QUERY_005.RFC_Loan_Nbr = QUERY_020.RFC_Loan_Nbr
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	QUERY_021 ON QUERY_005.RFC_Loan_Nbr = QUERY_021.RFC_Loan_Nbr
LEFT JOIN
	QUERY_022 ON QUERY_005.RFC_Loan_Nbr = QUERY_022.LOAN_NUMBER
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
LEFT JOIN
	QUERY_036 ON QUERY_005.RFC_Loan_Nbr = QUERY_036.ASSET_SEQ_ID
LEFT JOIN
	QUERY_024 ON QUERY_005.RFC_Loan_Nbr = QUERY_024.LOAN_NUMBER
LEFT JOIN
	QUERY_031 ON QUERY_005.RFC_Loan_Nbr = QUERY_031.LOAN_NUMBER
LEFT JOIN
	QUERY_013 ON QUERY_005.RFC_Loan_Nbr = QUERY_013.LOAN_NUMBER
WHERE
	QUERY_005.LOAN_STATUS In ('1')
	AND QUERY_020.RFC_Loan_Nbr Is Null
	AND query_005.BGN_INVESTOR_BALANCE <>0
	AND QUERY_005.REO_STATUS='N'
	AND QUERY_012.LOAN_NUMBER Is Null
)




/*
4i_Get_Active_NonREO_DF = QUERY_043
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/

,QUERY_043 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	(query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100)-(QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100) AS Servicer_Fee_Rate,
	QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100 AS SubServicer_Fee_Rate,
	CASE
		WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
		THEN query_005.SCHED_SVC_FEE_AMOUNT  
		ELSE 0
	END AS Serv_Fee_Amt,
	0 AS New_Pay_Amt,
	Round(
		CASE
			WHEN query_005.END_SCHED_NOTE_RATE <>query_005.BGN_SCHED_INV_NOTE_RATE 
			THEN query_005.END_SCHED_NOTE_RATE *100
			ELSE 0
		END,3) AS New_Loan_Rate,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.defrd_part_principal  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.defrd_part_principal  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	CASE
		WHEN QUERY_020.Total_DF_Amt<>0 AND QUERY_018.RFC_Loan_Nbr IS NULL
		THEN QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_020.HFDP_Amt
		ELSE 0
	END AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	CASE
		WHEN QUERY_020.Total_DF_Amt=0
		THEN 0
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN 0
		ELSE QUERY_005.PRINCIPAL_ADJUSTMENTS
	END AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	0 AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	Null AS PIF_Date,
	Null AS Action_Code,
	Null AS Beach_Flag,
	CASE
		WHEN QUERY_020.RFC_Loan_Nbr Is Not Null
		THEN QUERY_005.ANCILLARY_FEES_REMITTED_INV
				-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV
				-QUERY_020.ANCILLARY_FEE_AMOUNT
				-QUERY_024.Int_Adj_Amt
				+QUERY_020.MDFP_Amt+QUERY_020.MDFI_Amt
				+QUERY_020.MDFF_Amt
		ELSE QUERY_005.ANCILLARY_FEES_REMITTED_INV
				-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV
				-QUERY_020.ANCILLARY_FEE_AMOUNT
				-QUERY_024.Int_Adj_Amt
	END AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	0 AS SSA_Adj,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null AND QUERY_016.MODIFICATION_CODE Not Like '4'
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE
					-query_005.BGN_SCHED_INV_SVC_FEE_RATE  )
					-((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )))*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END ,2) AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	0 AS Loan_Loss_Amt,
	0 AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.defrd_part_principal  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	CASE
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN QUERY_005.PRINCIPAL_ADJUSTMENTS
				+QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED
				+query_005.SCHED_PRINCIPAL_AMOUNT 
				-QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
				+QUERY_020.HFDP_Amt
		ELSE query_005.SCHED_PRINCIPAL_AMOUNT 
				-QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
	END AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	Round(QUERY_005.INTEREST_REMITTED
		-CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN query_005.BGN_INVESTOR_BALANCE *QUERY_010.LPMI_RATE/1200
			ELSE 0
		END,2) AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS Prepay_Penalty_Waived,
	Null AS Waived_PPP_Reason,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN QUERY_016.MOD_EFFECTIVE_DATE
		ELSE Null
	END AS Mod_Date,
	CASE
		WHEN QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN 'Loss Mitigation'
		ELSE Null
	END AS Mod_Type,
	CASE
		WHEN QUERY_013.LOAN_NUMBER Is Not Null
		THEN QUERY_013.Delinq_PI_Advance_Amt
		ELSE 0
	END AS Delinq_PI_Advance_Amt,
	0 AS Sub_Recovery_Amt,
	QUERY_022.PrePmt_Int_SF_Amt AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_012 ON QUERY_005.RFC_Loan_Nbr = QUERY_012.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_020 ON QUERY_005.RFC_Loan_Nbr = QUERY_020.RFC_Loan_Nbr
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	QUERY_021 ON QUERY_005.RFC_Loan_Nbr = QUERY_021.RFC_Loan_Nbr
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
LEFT JOIN
	QUERY_022 ON QUERY_005.RFC_Loan_Nbr = QUERY_022.LOAN_NUMBER
LEFT JOIN
	QUERY_024 ON QUERY_005.RFC_Loan_Nbr = QUERY_024.LOAN_NUMBER
LEFT JOIN
	QUERY_013 ON QUERY_005.RFC_Loan_Nbr = QUERY_013.LOAN_NUMBER
WHERE
	QUERY_005.LOAN_STATUS In ('1')
	AND QUERY_020.RFC_Loan_Nbr Is Not Null
	AND query_005.BGN_INVESTOR_BALANCE <>0
	AND QUERY_005.REO_STATUS='N'
	AND QUERY_012.LOAN_NUMBER Is Null
)





/*
4j_Get_Active_REO = QUERY_044
=======================================================
NOTE: ADDED AS UNION SELECT ABOVE (QUERY_037)
=======================================================
*/
,QUERY_044 AS
(
SELECT
	QUERY_005.SALE_NUMBER AS Ser_Investor_Nbr,
	QUERY_005.LOAN_NUMBER AS RFC_Loan_Nbr,
	tbl_Wells_Inv_Numbers.Loan_Nbr AS Loan_Nbr,
	query_005.BGN_SCHED_INV_PMT_AMT  AS Sched_Pay_Amt,
	query_005.BGN_SCHED_INV_NOTE_RATE *100 AS Note_Int_Rate,
	CASE
		WHEN QUERY_010.LOAN_NUMBER Is Not Null
		THEN ((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100)
				-QUERY_010.LPMI_RATE
		ELSE (query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )*100
	END AS Net_Int_Rate,
	(query_005.BGN_SCHED_INV_SVC_FEE_RATE  *100)-(QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100) AS Service_Fee_Rate,
	QUERY_006.PUR_CURRENT_SERVICE_FEE_RATE*100 AS SubServicer_Fee_Rate,
	CASE
		WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
		THEN query_005.SCHED_SVC_FEE_AMOUNT  
		ELSE 0
	END AS Serv_Fee_Amt,
	0 AS New_Pay_Amt,
	CASE
		WHEN query_005.END_SCHED_NOTE_RATE <>query_005.BGN_SCHED_INV_NOTE_RATE 
		THEN query_005.END_SCHED_NOTE_RATE *100
		ELSE 0
	END AS New_Loan_Rate,
	QUERY_009.PUBLISHED_INDEX_VALUE*100 AS ARM_Index_Rate,
	QUERY_002.LOAN_PARTICIPANT_PRINCIPAL AS Act_Beg_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL AS Actl_End_Prin_Bal,
	QUERY_005.LOAN_PARTICIPANT_PRINCIPAL+query_005.defrd_part_principal  AS ACT_END_PBAL_TOT_DEBT_OWD,
	query_005.defrd_part_principal  AS Defer_Amount,
	QUERY_005.LOAN_DUE_DATE AS Borr_Next_Pay_Due_Date,
	CASE
		WHEN QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED Is Null
		THEN 0
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN 0
		WHEN (QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)=0
		THEN 0
		ELSE QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED
	END AS Serv_Curt_Amt_1,
	Null AS Serv_Curt_Date_1,
	Null AS Serv_Curt_Adj_1,
	CASE
		WHEN QUERY_005.PRINCIPAL_ADJUSTMENTS Is Null
		THEN 0
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN 0
		WHEN (QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED+QUERY_005.PRINCIPAL_ADJUSTMENTS)=0
		THEN 0
		ELSE QUERY_005.PRINCIPAL_ADJUSTMENTS
	END AS Serv_Curt_Amt_2,
	Null AS Serv_Curt_Date_2,
	Null AS Serv_Curt_Adj_2,
	0 AS Serv_Curt_Amt_3,
	Null AS Serv_Curt_Date_3,
	Null AS Serv_Curt_Adj_3,
	0 AS PIF_Amt,
	Null AS PIF_Date,
	'70' AS Action_Code,
	Null AS Beach_Flag,
	QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.ANCILLARY_PREPAY_REMITTED_INV-QUERY_024.Int_Adj_Amt AS Int_Adj_Amt,
	0 AS Prin_Adj_Amt,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null AND QUERY_016.MODIFICATION_CODE Like '4' AND QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE-query_005.BGN_SCHED_INV_SVC_FEE_RATE  )
					-((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )))
					*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END,2) AS SSA_Adj,
	Round(
		CASE
			WHEN QUERY_016.RFC_Loan_Nbr Is Not Null AND QUERY_016.MODIFICATION_CODE Not Like '4' AND QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y'
			THEN ((QUERY_016.BEFORE_SALE_SCHED_NOTE_RATE-query_005.BGN_SCHED_INV_SVC_FEE_RATE  )
					-((query_005.BGN_SCHED_INV_NOTE_RATE -query_005.BGN_SCHED_INV_SVC_FEE_RATE  )))
					*query_005.BGN_INVESTOR_BALANCE /12
			ELSE 0
		END,2) AS Mod_SF_Adj,
	Null AS Non_Adv_Ln_Amt,
	0 AS Loan_Loss_Amt,
	0 AS Int_Loss_Amt,
	query_005.BGN_INVESTOR_BALANCE  AS Sched_Beg_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL  AS Sched_End_Prin_Bal,
	query_005.END_SCHED_PART_PRINCIPAL +query_005.defrd_part_principal  AS SCHD_END_PBAL_TOT_DEBT_OWD,
	CASE
		WHEN QUERY_018.RFC_Loan_Nbr Is Not Null
		THEN QUERY_005.PRINCIPAL_ADJUSTMENTS
				+QUERY_005.ADDITIONAL_PRINCIPAL_COLLECTED
				+query_005.SCHED_PRINCIPAL_AMOUNT 
				-QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
		ELSE query_005.SCHED_PRINCIPAL_AMOUNT 
				-QUERY_005.REO_BACKED_OUT_SCHED_PRINCIPAL
	END AS Sched_Prin_Amt,
	Null AS Deferred_Int_Amt,
	Round(QUERY_005.INTEREST_REMITTED
		-CASE
			WHEN QUERY_010.LOAN_NUMBER Is Not Null
			THEN query_005.BGN_INVESTOR_BALANCE 
					*QUERY_010.LPMI_RATE/1200
			ELSE 0
		END,2) AS Sched_Net_Int,
	0 AS Actl_Prin_Amt,
	0 AS Actual_Net_Int,
	QUERY_005.ANCILLARY_PREPAY_REMITTED_INV AS Prepay_Penalty_Amt,
	Null AS PPP_Waived,
	Null AS PPP_Waived_Reason,
	CASE
		WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y' AND QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN QUERY_016.MOD_EFFECTIVE_DATE
		ELSE Null
	END AS Mod_Date,
	CASE
		WHEN QUERY_005.INVESTOR_ADVANCING_STATUS Like 'Y' AND QUERY_016.RFC_Loan_Nbr Is Not Null
		THEN 'Loss Mitigation'
		ELSE Null
	END AS Mod_Type,
	CASE
		WHEN QUERY_013.LOAN_NUMBER Is Not Null
		THEN QUERY_013.Delinq_PI_Advance_Amt
		ELSE 0
	END AS Delinq_PI_Advance_Amt,
	0 AS Sub_Recovery_Amt,
	0 AS PrePmt_Int_SF_Amt,
	QUERY_005.LOAN_STATUS,
	QUERY_005.LOAN_STATUS_DATE,
	QUERY_005.Determination_Day
FROM
	QUERY_005
LEFT JOIN
	QUERY_006 ON QUERY_005.RFC_Loan_Nbr = QUERY_006.LOAN_NUMBER
LEFT JOIN
	QUERY_009 ON QUERY_005.RFC_Loan_Nbr = QUERY_009.RFC_Loan_Nbr
LEFT JOIN
	QUERY_012 ON QUERY_005.RFC_Loan_Nbr = QUERY_012.LOAN_NUMBER
LEFT JOIN
	QUERY_018 ON QUERY_005.RFC_Loan_Nbr = QUERY_018.RFC_Loan_Nbr
LEFT JOIN
	QUERY_010 ON QUERY_005.RFC_Loan_Nbr = QUERY_010.LOAN_NUMBER
LEFT JOIN
	QUERY_002 ON QUERY_005.RFC_Loan_Nbr = QUERY_002.LOAN_NUMBER
LEFT JOIN
	QUERY_016 ON QUERY_005.RFC_Loan_Nbr = QUERY_016.RFC_Loan_Nbr
LEFT JOIN
	QUERY_021 ON QUERY_005.RFC_Loan_Nbr = QUERY_021.RFC_Loan_Nbr
LEFT JOIN
	QUERY_022 ON QUERY_005.LOAN_NUMBER = QUERY_022.LOAN_NUMBER
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_005.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
LEFT JOIN
	QUERY_024 ON QUERY_005.RFC_Loan_Nbr = QUERY_024.LOAN_NUMBER
LEFT JOIN
	QUERY_013 ON QUERY_005.RFC_Loan_Nbr = QUERY_013.LOAN_NUMBER
WHERE
	QUERY_005.LOAN_STATUS In ('1')
	AND query_005.BGN_INVESTOR_BALANCE <>0
	AND QUERY_005.REO_STATUS='Y'
	AND QUERY_012.LOAN_NUMBER Is Null
)



/*
FINAL_REPORT
=======================================================
NOTE: ALL QUERIES UNION SELECTED INTO FINAL REPORT
=======================================================
*/

,QUERY_037 AS
(
SELECT * FROM QUERY_037a
UNION SELECT * FROM QUERY_038
UNION SELECT * FROM QUERY_039
UNION SELECT * FROM QUERY_040
UNION SELECT * FROM QUERY_041
UNION SELECT * FROM QUERY_042
UNION SELECT * FROM QUERY_043
UNION SELECT * FROM QUERY_044
)

/*
Remaining queries apart from macros are provided below
=======================================================
NOTE: 
=======================================================
*/



/*
5a_WellsReport_Final_15th
=======================================================
NOTE: 
=======================================================
*/
,A5a_Wells_Final_15th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	QUERY_037.RFC_Loan_Nbr,
	CASE
		WHEN tbl_Wells_Inv_Numbers.RFC_Loan_Nbr Is Not Null
		THEN tbl_Wells_Inv_Numbers.Loan_Nbr
		ELSE Null
	END AS Loan_Nbr,
	QUERY_037.Sched_Pay_Amt,
	QUERY_037.Note_Int_Rate,
	QUERY_037.Net_Int_Rate,
	QUERY_037.SubServicer_Fee_Rate,
	QUERY_037.Servicer_Fee_Rate,
	QUERY_037.Serv_Fee_Amt,
	QUERY_037.New_Loan_Rate,
	QUERY_037.New_Pay_Amt,
	QUERY_037.ARM_Index_Rate,
	QUERY_037.Actl_Beg_Prin_Bal,
	QUERY_037.Actl_End_Prin_Bal,
	QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD,
	NVL(QUERY_037.Defer_Amount,0) AS Defer_Amount,
	QUERY_037.Borr_Next_Pay_Due_Date,
	QUERY_037.Serv_Curt_Amt_1,
	QUERY_037.Serv_Curt_Date_1,
	QUERY_037.Curt_Adj_Amt_1,
	QUERY_037.Serv_Curt_Amt_2,
	QUERY_037.Serv_Curt_Date_2,
	QUERY_037.Curt_Adj_Amt_2,
	QUERY_037.Serv_Curt_Amt_3,
	QUERY_037.Serv_Curt_Date_3,
	QUERY_037.Curt_Adj_Amt_3,
	QUERY_037.PIF_Amt,
	QUERY_037.PIF_Date,
	CASE
		WHEN QUERY_037.Action_Code Is Not Null
		THEN QUERY_037.Action_Code
		WHEN QUERY_031.LOAN_NUMBER Is Not Null
		THEN '15'
		WHEN QUERY_036.LOAN_NUMBER Is Not Null
		THEN '30'
		ELSE Null
	END AS Action_Code,
	QUERY_037.Breach_Flag,
	QUERY_037.Int_Adj_Amt,
	QUERY_037.Prin_Adj_Amt,
	QUERY_037.Soldier_Sailors_Adj_Amt,
	QUERY_037.Mod_SF_Amt,
	QUERY_037.Non_Adv_Loan_Amt,
	QUERY_037.Loan_Loss_Amt,
	QUERY_037.Int_Loss_Amt,
	QUERY_037.Sched_Beg_Prin_Bal,
	QUERY_037.Sched_End_Prin_Bal,
	QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD,
	QUERY_037.Sched_Prin_Amt,
	QUERY_037.Deferred_Int_Amt,
	QUERY_037.Sched_Net_Int,
	QUERY_037.Actl_Prin_Amt,
	QUERY_037.Actl_Net_Int,
	QUERY_037.Prepay_Penalty_Amt,
	QUERY_037.Prepay_Penalty_Waived,
	QUERY_037.Waived_PPP_Reason,
	QUERY_037.Mod_Date,
	QUERY_037.Mod_Type,
	QUERY_037.Delinq_PandI_Advance_Amt,
	QUERY_037.Sub_Recovery_Amt,
	QUERY_037.PrePmt_Int_SF_Amt,
	QUERY_037.LOAN_STATUS,
	QUERY_037.LOAN_STATUS_DATE,
	QUERY_037.Determination_Day
FROM 
    QUERY_037
LEFT JOIN
	QUERY_036 ON QUERY_037.Loan_Nbr = QUERY_036.LOAN_NUMBER
LEFT JOIN
	QUERY_031 ON QUERY_037.Loan_Nbr = QUERY_031.LOAN_NUMBER 
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_037.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
WHERE
	QUERY_037.Determination_Day=15
)



/*
5b_WellsReport_Final_16th
=======================================================
NOTE: 
=======================================================
*/
,A5b_Wells_Final_16th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	QUERY_037.RFC_Loan_Nbr,
	CASE
		WHEN tbl_Wells_Inv_Numbers.RFC_Loan_Nbr Is Not Null
		THEN tbl_Wells_Inv_Numbers.Loan_Nbr
		ELSE Null
	END AS Loan_Nbr,
	QUERY_037.Sched_Pay_Amt,
	QUERY_037.Note_Int_Rate,
	QUERY_037.Net_Int_Rate,
	QUERY_037.SubServicer_Fee_Rate,
	QUERY_037.Servicer_Fee_Rate,
	QUERY_037.Serv_Fee_Amt,
	QUERY_037.New_Loan_Rate,
	QUERY_037.New_Pay_Amt,
	QUERY_037.ARM_Index_Rate,
	QUERY_037.Actl_Beg_Prin_Bal,
	QUERY_037.Actl_End_Prin_Bal,
	QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD,
	NVL(QUERY_037.Defer_Amount,0) AS Defer_Amount,
	QUERY_037.Borr_Next_Pay_Due_Date,
	QUERY_037.Serv_Curt_Amt_1,
	QUERY_037.Serv_Curt_Date_1,
	QUERY_037.Curt_Adj_Amt_1,
	QUERY_037.Serv_Curt_Amt_2,
	QUERY_037.Serv_Curt_Date_2,
	QUERY_037.Curt_Adj_Amt_2,
	QUERY_037.Serv_Curt_Amt_3,
	QUERY_037.Serv_Curt_Date_3,
	QUERY_037.Curt_Adj_Amt_3,
	QUERY_037.PIF_Amt,
	QUERY_037.PIF_Date,
	CASE
		WHEN QUERY_037.Action_Code Is Not Null
		THEN QUERY_037.Action_Code
		WHEN QUERY_031.LOAN_NUMBER Is Not Null
		THEN '15'
		WHEN QUERY_036.LOAN_NUMBER Is Not Null
		THEN '30'
		ELSE Null
	END AS Action_Code,
	QUERY_037.Breach_Flag,
	QUERY_037.Int_Adj_Amt,
	QUERY_037.Prin_Adj_Amt,
	QUERY_037.Soldier_Sailors_Adj_Amt,
	QUERY_037.Mod_SF_Amt,
	QUERY_037.Non_Adv_Loan_Amt,
	QUERY_037.Loan_Loss_Amt,
	QUERY_037.Int_Loss_Amt,
	QUERY_037.Sched_Beg_Prin_Bal,
	QUERY_037.Sched_End_Prin_Bal,
	QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD,
	QUERY_037.Sched_Prin_Amt,
	QUERY_037.Deferred_Int_Amt,
	QUERY_037.Sched_Net_Int,
	QUERY_037.Actl_Prin_Amt,
	QUERY_037.Actl_Net_Int,
	QUERY_037.Prepay_Penalty_Amt,
	QUERY_037.Prepay_Penalty_Waived,
	QUERY_037.Waived_PPP_Reason,
	QUERY_037.Mod_Date,
	QUERY_037.Mod_Type,
	QUERY_037.Delinq_PandI_Advance_Amt,
	QUERY_037.Sub_Recovery_Amt,
	QUERY_037.PrePmt_Int_SF_Amt,
	QUERY_037.LOAN_STATUS,
	QUERY_037.LOAN_STATUS_DATE,
	QUERY_037.Determination_Day
FROM
	QUERY_037
LEFT JOIN
	QUERY_036 ON QUERY_037.Loan_Nbr = QUERY_036.LOAN_NUMBER 
LEFT JOIN
	QUERY_031 ON QUERY_037.Loan_Nbr = QUERY_031.LOAN_NUMBER
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_037.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
WHERE
	QUERY_037.Determination_Day=16
)





/*
5c_WellsReport_Final_20th
=======================================================
NOTE: 
=======================================================
*/
,A5c_WellsReport_Final_20th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	QUERY_037.RFC_Loan_Nbr,
	CASE
		WHEN tbl_Wells_Inv_Numbers.RFC_Loan_Nbr Is Not Null
		THEN tbl_Wells_Inv_Numbers.Loan_Nbr
		ELSE Null
	END AS Loan_Nbr,
	QUERY_037.Sched_Pay_Amt,
	QUERY_037.Note_Int_Rate,
	QUERY_037.Net_Int_Rate,
	QUERY_037.SubServicer_Fee_Rate,
	QUERY_037.Servicer_Fee_Rate,
	QUERY_037.Serv_Fee_Amt,
	QUERY_037.New_Loan_Rate,
	QUERY_037.New_Pay_Amt,
	QUERY_037.ARM_Index_Rate,
	QUERY_037.Actl_Beg_Prin_Bal,
	QUERY_037.Actl_End_Prin_Bal,
	QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD,
	NVL(QUERY_037.Defer_Amount,0) AS Defer_Amount,
	QUERY_037.Borr_Next_Pay_Due_Date,
	QUERY_037.Serv_Curt_Amt_1,
	QUERY_037.Serv_Curt_Date_1,
	QUERY_037.Curt_Adj_Amt_1,
	QUERY_037.Serv_Curt_Amt_2,
	QUERY_037.Serv_Curt_Date_2,
	QUERY_037.Curt_Adj_Amt_2,
	QUERY_037.Serv_Curt_Amt_3,
	QUERY_037.Serv_Curt_Date_3,
	QUERY_037.Curt_Adj_Amt_3,
	QUERY_037.PIF_Amt,
	QUERY_037.PIF_Date,
	CASE
		WHEN QUERY_037.Action_Code Is Not Null
		THEN QUERY_037.Action_Code
		WHEN QUERY_031.LOAN_NUMBER Is Not Null
		THEN '15'
		WHEN QUERY_036.LOAN_NUMBER Is Not Null
		THEN '30'
		ELSE Null
	END AS Action_Code,
	QUERY_037.Breach_Flag,
	QUERY_037.Int_Adj_Amt,
	QUERY_037.Prin_Adj_Amt,
	QUERY_037.Soldier_Sailors_Adj_Amt,
	QUERY_037.Mod_SF_Amt,
	QUERY_037.Non_Adv_Loan_Amt,
	QUERY_037.Loan_Loss_Amt,
	QUERY_037.Int_Loss_Amt,
	QUERY_037.Sched_Beg_Prin_Bal,
	QUERY_037.Sched_End_Prin_Bal,
	QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD,
	QUERY_037.Sched_Prin_Amt,
	QUERY_037.Deferred_Int_Amt,
	QUERY_037.Sched_Net_Int,
	QUERY_037.Actl_Prin_Amt,
	QUERY_037.Actl_Net_Int,
	QUERY_037.Prepay_Penalty_Amt,
	QUERY_037.Prepay_Penalty_Waived,
	QUERY_037.Waived_PPP_Reason,
	QUERY_037.Mod_Date,
	QUERY_037.Mod_Type,
	QUERY_037.Delinq_PandI_Advance_Amt,
	QUERY_037.Sub_Recovery_Amt,
	QUERY_037.PrePmt_Int_SF_Amt,
	QUERY_037.LOAN_STATUS,
	QUERY_037.LOAN_STATUS_DATE,
	QUERY_037.Determination_Day
FROM
	QUERY_037
LEFT JOIN
	QUERY_036 ON QUERY_037.Loan_Nbr = QUERY_036.LOAN_NUMBER
LEFT JOIN
	QUERY_031 ON QUERY_037.Loan_Nbr = QUERY_031.LOAN_NUMBER
LEFT JOIN
	tbl_Wells_Inv_Numbers ON QUERY_037.RFC_Loan_Nbr = tbl_Wells_Inv_Numbers.RFC_Loan_Nbr
WHERE
	QUERY_037.Determination_Day=20
)



/*
6_Sum_Cash_Summary_Report_15th
=======================================================
NOTE: 
=======================================================
*/
,A6_Sum_Cash_Summary_15th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	Sum(QUERY_037.Sched_Beg_Prin_Bal) AS Sched_Beg_Prin_Bal,
	Sum(QUERY_037.Sched_End_Prin_Bal) AS Sched_End_Prin_Bal,
	Sum(QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD) AS SumSCHD_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Actl_Beg_Prin_Bal) AS Actl_Beg_Prin_Bal,
	Sum(QUERY_037.Actl_End_Prin_Bal) AS Actl_End_Prin_Bal,
	Sum(QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD) AS SumACT_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.Sched_Prin_Amt+QUERY_037.PIF_Amt) AS Principal_Distribution,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt
			ELSE QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt
		END ) AS Interest_Distribution,
	Sum(QUERY_037.Loan_Loss_Amt) AS Principal_Loss,
	Sum(QUERY_037.Int_Loss_Amt) AS Interest_Loss,
	Sum(QUERY_037.Sub_Recovery_Amt) AS Sub_Recovery,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN 0
			ELSE QUERY_037.PrePmt_Int_SF_Amt
		END) AS PrePmt_Int_SF,
	Null AS PrePmt_Int_SF2,
	Sum(CASE
		WHEN QUERY_037.Determination_Day=20
		THEN QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt
		ELSE QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt+QUERY_037.PrePmt_Int_SF_Amt
		END) AS Total_Distribution,
	tbl_AAR_Pools.Determination_Day
FROM
	QUERY_037
LEFT JOIN
	tbl_AAR_Pools ON QUERY_037.Ser_Investor_Nbr = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
	QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	tbl_AAR_Pools.Determination_Day
HAVING
	tbl_AAR_Pools.Determination_Day IN (15)
ORDER BY
	tbl_AAR_Pools.Determination_Day DESC
)







/*
6_Sum_Cash_Summary_Report_16th
=======================================================
NOTE: 
=======================================================
*/
,A6_Sum_Cash_Summary_16th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	Sum(QUERY_037.Sched_Beg_Prin_Bal) AS Sched_Beg_Prin_Bal,
	Sum(QUERY_037.Sched_End_Prin_Bal) AS Sched_End_Prin_Bal,
	Sum(QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD) AS SumSCHD_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Actl_Beg_Prin_Bal) AS Actl_Beg_Prin_Bal,
	Sum(QUERY_037.Actl_End_Prin_Bal) AS Actl_End_Prin_Bal,
	Sum(QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD) AS SumACT_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.Sched_Prin_Amt+QUERY_037.PIF_Amt) AS Principal_Distribution,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt
			ELSE QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt
		END) AS Interest_Distribution,
	Sum(QUERY_037.Loan_Loss_Amt) AS Principal_Loss,
	Sum(QUERY_037.Int_Loss_Amt) AS Interest_Loss,
	Sum(QUERY_037.Sub_Recovery_Amt) AS Sub_Recovery,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN 0
			ELSE QUERY_037.PrePmt_Int_SF_Amt
		END)AS PrePmt_Int_SF,
	Null AS PrePmt_Int_SF2,
	Sum(CASE
		WHEN QUERY_037.Determination_Day=20
		THEN QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt
		ELSE QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt+QUERY_037.PrePmt_Int_SF_Amt
		END) AS Total_Distribution,
	tbl_AAR_Pools.Determination_Day
FROM QUERY_037 LEFT JOIN tbl_AAR_Pools ON QUERY_037.Ser_Investor_Nbr = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	tbl_AAR_Pools.Determination_Day
HAVING (((tbl_AAR_Pools.Determination_Day) In (16)))
ORDER BY tbl_AAR_Pools.Determination_Day DESC
)





/*
6_Sum_cash_Summary_Report_20th
=======================================================
NOTE: 
=======================================================
*/
,A6_Sum_cash_Summary_20th AS
(
SELECT
	QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	Sum(QUERY_037.Sched_Beg_Prin_Bal) AS Sched_Beg_Prin_Bal,
	Sum(QUERY_037.Sched_End_Prin_Bal) AS Sched_End_Prin_Bal,
	Sum(QUERY_037.SCHD_END_PBAL_TOT_DEBT_OWD) AS SumSCHD_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Actl_Beg_Prin_Bal) AS Actl_Beg_Prin_Bal,
	Sum(QUERY_037.Actl_End_Prin_Bal) AS Actl_End_Prin_Bal,
	Sum(QUERY_037.ACT_END_PBAL_TOT_DEBT_OWD) AS SumACT_END_PBAL_TOT_DEBT_OWD,
	Sum(QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.Sched_Prin_Amt+QUERY_037.PIF_Amt) AS Principal_Distribution,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt
			ELSE QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt 
		END) AS Interest_Distribution,
	Sum(QUERY_037.Loan_Loss_Amt) AS Principal_Loss,
	Sum(QUERY_037.Int_Loss_Amt) AS Interest_Loss,
	Sum(QUERY_037.Sub_Recovery_Amt) AS Sub_Recovery,
	Sum(CASE
			WHEN tbl_AAR_Pools.Determination_Day=20
			THEN 0
			ELSE QUERY_037.PrePmt_Int_SF_Amt
		END) AS PrePmt_Int_SF,
	Null AS PrePmt_Int_SF2,
	Sum(CASE
		WHEN QUERY_037.Determination_Day=20
		THEN QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt
		ELSE QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sub_Recovery_Amt+QUERY_037.PrePmt_Int_SF_Amt 
		END) AS Total_Distribution,
	tbl_AAR_Pools.Determination_Day
FROM
    QUERY_037
LEFT JOIN
    tbl_AAR_Pools ON QUERY_037.Ser_Investor_Nbr = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
    QUERY_037.Ser_Investor_Nbr,
	tbl_AAR_Pools.RFC_Deal_Series,
	tbl_AAR_Pools.Determination_Day
HAVING
    tbl_AAR_Pools.Determination_Day In (20)
ORDER BY
    tbl_AAR_Pools.Determination_Day DESC
)








/*
y_Get Sum_SBO_IRH_Cash_fields_15th_16th
=======================================================
NOTE: 
=======================================================
*/
,y_Sum_SBO_IRH_15th_16th AS
(
SELECT
	QUERY_005.LAST_INVESTOR_CUTOFF_DATE,
	QUERY_005.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
	QUERY_005.RFC_Deal_Series,
	Sum(QUERY_005.INTEREST_REMITTED) AS SumINTEREST_REMITTED,
	Sum(QUERY_005.PRINCIPAL_REMITTED) AS SumPRINCIPAL_REMITTED,
	Sum(QUERY_005.ANCILLARY_FEES_REMITTED_INV) AS SumANCILLARY_FEES_REMITTED_INV,
	Sum(((QUERY_005.ANCILLARY_FEES_REMITTED_INV+QUERY_005.PRINCIPAL_REMITTED+QUERY_005.INTEREST_REMITTED))) AS Total_SBO,
	Sum(((QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Sub_Recovery_Amt+QUERY_037.PrePmt_Int_SF_Amt)-QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.INTEREST_REMITTED-QUERY_005.PRINCIPAL_REMITTED)) AS "Check",
	Sum(Round(CASE
				WHEN QUERY_011.LOAN_NUMBER Is Not Null
				THEN QUERY_011.LPMI_RATE/1200*QUERY_005.BGN_INVESTOR_BALANCE
				ELSE 0
            END,2)) AS LPMI,
	Sum(CASE
			WHEN QUERY_005.LOAN_STATUS In ('2','D','H')
            THEN QUERY_037.PrePmt_Int_SF_Amt
            ELSE 0
        END) AS Payoff_Comp,
	Sum(CASE
			WHEN QUERY_005.LOAN_STATUS Not In ('2','D','H')
			THEN QUERY_037.PrePmt_Int_SF_Amt
			ELSE 0
		END) AS IOC,
	Sum(QUERY_037.PrePmt_Int_SF_Amt) AS Total_Comp,
	Sum(Round(CASE
					WHEN QUERY_011.LOAN_NUMBER Is Not Null
					THEN QUERY_011.LPMI_RATE/1200*QUERY_005.BGN_INVESTOR_BALANCE
					ELSE 0
                END,2)
                +(QUERY_005.PRINCIPAL_REMITTED+QUERY_005.ANCILLARY_FEES_REMITTED_INV+QUERY_005.INTEREST_REMITTED)
                +(QUERY_037.PrePmt_Int_SF_Amt)
                ) AS Total_Dist
FROM
    QUERY_005
LEFT JOIN
    QUERY_037 ON QUERY_005.RFC_Loan_Nbr = QUERY_037.RFC_Loan_Nbr
LEFT JOIN
    QUERY_011 ON QUERY_005.RFC_Loan_Nbr = QUERY_011.LOAN_NUMBER
LEFT JOIN
    tbl_AAR_Pools ON QUERY_005.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
    QUERY_005.LAST_INVESTOR_CUTOFF_DATE,
	QUERY_005.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
	QUERY_005.RFC_Deal_Series
HAVING
    tbl_AAR_Pools.Determination_Day<>20
ORDER BY
    tbl_AAR_Pools.Determination_Day
)






/*
y_Get Sum_SBO_IRH_Cash_fields_20th
=======================================================
NOTE: 
=======================================================
*/
,y_get_SBO_IRH_20th AS
(
SELECT
	QUERY_005.LAST_INVESTOR_CUTOFF_DATE,
	QUERY_005.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
	QUERY_005.RFC_Deal_Series,
	Sum(QUERY_005.INTEREST_REMITTED) AS SumINTEREST_REMITTED,
	Sum(QUERY_005.PRINCIPAL_REMITTED) AS SumPRINCIPAL_REMITTED,
	Sum(QUERY_005.ANCILLARY_FEES_REMITTED_INV) AS SumANCILLARY_FEES_REMITTED_INV,
	Sum(((QUERY_005.ANCILLARY_FEES_REMITTED_INV+QUERY_005.PRINCIPAL_REMITTED+QUERY_005.INTEREST_REMITTED))) AS Total_SBO,
	Sum(((QUERY_037.Serv_Curt_Amt_1+QUERY_037.Serv_Curt_Amt_2+QUERY_037.PIF_Amt+QUERY_037.Int_Adj_Amt+QUERY_037.Loan_Loss_Amt+QUERY_037.Int_Loss_Amt+QUERY_037.Sched_Prin_Amt+QUERY_037.Sched_Net_Int+QUERY_037.Prepay_Penalty_Amt+QUERY_037.Sub_Recovery_Amt+QUERY_037.PrePmt_Int_SF_Amt)-QUERY_005.ANCILLARY_FEES_REMITTED_INV-QUERY_005.INTEREST_REMITTED-QUERY_005.PRINCIPAL_REMITTED)) AS "Check",
	Sum(Round(CASE
				WHEN QUERY_011.LOAN_NUMBER Is Not Null
				THEN QUERY_011.LPMI_RATE/1200*QUERY_005.BGN_INVESTOR_BALANCE
				ELSE 0
            END,2)) AS LPMI,
	Sum(CASE
			WHEN QUERY_005.LOAN_STATUS In ('2','D','H')
            THEN QUERY_037.PrePmt_Int_SF_Amt
            ELSE 0
        END) AS Payoff_Comp,
	Sum(CASE
			WHEN QUERY_005.LOAN_STATUS Not In ('2','D','H')
			THEN QUERY_037.PrePmt_Int_SF_Amt
			ELSE 0
		END) AS IOC,
	Sum(QUERY_037.PrePmt_Int_SF_Amt) AS Total_Comp,
	Sum(Round(CASE
					WHEN QUERY_011.LOAN_NUMBER Is Not Null
					THEN QUERY_011.LPMI_RATE/1200*QUERY_005.BGN_INVESTOR_BALANCE
					ELSE 0
                END,2)
                +(QUERY_005.PRINCIPAL_REMITTED+QUERY_005.ANCILLARY_FEES_REMITTED_INV+QUERY_005.INTEREST_REMITTED)
                +(QUERY_037.PrePmt_Int_SF_Amt)
                ) AS Total_Dist
FROM
    QUERY_005
LEFT JOIN
    QUERY_037 ON QUERY_005.RFC_Loan_Nbr = QUERY_037.RFC_Loan_Nbr
LEFT JOIN
    QUERY_011 ON QUERY_005.RFC_Loan_Nbr = QUERY_011.LOAN_NUMBER
LEFT JOIN
    tbl_AAR_Pools ON QUERY_005.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
    QUERY_005.LAST_INVESTOR_CUTOFF_DATE,
	QUERY_005.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
	QUERY_005.RFC_Deal_Series
HAVING
    tbl_AAR_Pools.Determination_Day=20
ORDER BY
    tbl_AAR_Pools.Determination_Day
)



/*
y_Get_SBO_Cash_Summary_15th_16th
=======================================================
NOTE: 
=======================================================
*/
,y_SBO_Summary_15th_16th AS
(
SELECT
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED) AS SumINTEREST_REMITTED,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED) AS SumPRINCIPAL_REMITTED,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV) AS SumANCILLARY_FEES_REMITTED_INV,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV+SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED+SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED) AS Total,
	SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day
FROM
	VARIABLES V,
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY LEFT JOIN tbl_AAR_Pools ON SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE,
	SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
    V.BEGIN_CYCLE_DATE
HAVING
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE > V.BEGIN_CYCLE_DATE
    AND tbl_AAR_Pools.Determination_Day<>20
)


/*
y_Get_SBO_Cash_Summary_20th
=======================================================
NOTE: 
=======================================================
*/
,y_SBO_Summary_20th AS
(
SELECT
	SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED) AS SumINTEREST_REMITTED,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED) AS SumPRINCIPAL_REMITTED,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV) AS SumANCILLARY_FEES_REMITTED_INV,
	Sum(SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.ANCILLARY_FEES_REMITTED_INV+SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.INTEREST_REMITTED+SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.PRINCIPAL_REMITTED) AS Total,
	SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day
FROM
	VARIABLES V,
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY LEFT JOIN tbl_AAR_Pools ON SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER = tbl_AAR_Pools.RFC_Actual_Pool_ID
GROUP BY
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE,
	SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.SALE_NUMBER,
	tbl_AAR_Pools.Determination_Day,
    V.BEGIN_CYCLE_DATE
HAVING
    SBO_MASTER.INVESTOR_REMITTANCE_HISTORY.LAST_INVESTOR_CUTOFF_DATE > V.BEGIN_CYCLE_DATE
	AND tbl_AAR_Pools.Determination_Day=20
)

"""
    script = masterscript + """SELECT * FROM y_SBO_Summary_20th"""
    
    cursor.execute(script)
    columns = [desc[0] for desc in cursor.description]
    data = cursor.fetchall()
    df1 = pd.DataFrame.from_records(data=data,columns=columns)
    df1.to_excel(writer, sheet_name=str(tab1),startcol=0,index=False)
    
    script = masterscript + """SELECT * FROM VARIABLES"""
    
    cursor.execute(script)
    columns = [desc[0] for desc in cursor.description]
    data = cursor.fetchall()
    df1 = pd.DataFrame.from_records(data=data,columns=columns)
    df1.to_excel(writer, sheet_name=str(tab2),startcol=0,index=False)

    writer.save()
    
    const=win32com.client.constants
    olMailItem = 0x0
    obj = win32com.client.Dispatch("Outlook.Application")
    newMail = obj.CreateItem(olMailItem)
    newMail.Subject = subject
    newMail.BodyFormat = 2 # olFormatHTML https://msdn.microsoft.com/en-us/library/office/aa219371(v=office.11).aspx
    newMail.HTMLBody = '<p>Report reference number: ' + reportnum +'</p><p>Date ran: ' + str(datetime.date.today()) +'</p><p>Report: ' + reportname +'</p><p>Located in the folder: ' + filelocation +'</p><p>To report any issues for this document, please include the report reference number.</p>'
    newMail.To = businessowner #<-----disable for production
    newMail.Cc = ccrecipients #<-----disable for production
    newMail.send
    
    logmessage(environment,'\n  SAVE LOCATION: ' + filelocation)
    logmessage(environment,'\n  FILE NAME: ' + filename)
    logmessage(environment,'\n  SUCCESSFULLY COMPLETED')

    print(subject + ' successfully sent')

except Exception as e:
    logmessage(environment,'\n  Exception: ' + str(e))
    print('Exception: ' + str(e))
    subject = 'FAILED - ' + reportnum + ' - '+ subject
    const=win32com.client.constants
    olMailItem = 0x0
    obj = win32com.client.Dispatch("Outlook.Application")
    newMail = obj.CreateItem(olMailItem)
    newMail.Subject = subject
    newMail.BodyFormat = 2 # olFormatHTML https://msdn.microsoft.com/en-us/library/office/aa219371(v=office.11).aspx
    newMail.HTMLBody = '<p>' + subject +'</p><p> Job failed with the following exception: </p><p>' + str(e) +'</p>'
    newMail.To = "brett.balsam@mortgagefamily.com" #<-----disable for production
    newMail.send
    print(subject + ' successfully sent')